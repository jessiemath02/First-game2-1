<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Jessie Mathï½œå†’éšªå³¶ 60 ç§’æŒ‘æˆ°</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root {
      --bg: #eef2ff;
      --card: #ffffff;
      --ink: #2d3436;
      --muted: #636e72;

      --brand: #6c5ce7;
      --brand-soft: #a29bfe;
      --accent: #fab1a0;
      --yellow: #fdcb6e;
      --green: #55efc4;
      --pink: #fd79a8;

      --shadow: 0 12px 0px rgba(0,0,0,0.05);
      --radius: 30px;

      /* âœ… æ ¸å¿ƒï¼šæ•´é«”éŠæˆ²å€æ¯”ä¾‹å›åˆ°ã€Œå”èª¿ã€ */
      --gameScale: clamp(1.00, 0.98 + 0.18vw, 1.10);

      /* âœ… è®“ä¸‰å¡Šæ–‡å­—å±¤ç´šæ›´åˆç†ï¼ˆæƒ…å¢ƒ < ç®—å¼ < é‡è¦æç¤ºï¼‰ */
      --sceneFont: clamp(20px, 0.8vw + 14px, 28px);
      --mathFont:  clamp(56px,  2.6vw + 26px, 92px);
      --mathFontCmp: clamp(64px, 3.0vw + 26px, 104px);
      --ansFont: clamp(18px, 0.9vw + 14px, 26px);

      --bubblePad: clamp(16px, 0.9vw + 10px, 22px);
      --mathMarginTop: clamp(14px, 1.2vw + 8px, 22px);
      --mathMarginBottom: clamp(10px, 1.0vw + 6px, 16px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin: 0;
      font-family: "Noto Sans TC", sans-serif;
      color: var(--ink);
      background-color: var(--bg);
      background-image:
        radial-gradient(circle at 10% 20%, rgba(108, 92, 231, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(253, 121, 168, 0.1) 0%, transparent 20%);
      overflow-x: hidden;
    }

    .wrap { max-width: 1100px; margin: 0 auto; padding: 20px 15px 50px; }

    /* Header */
    .hero {
      background: white;
      padding: 15px 0;
      border-bottom: 6px solid var(--brand-soft);
      border-radius: 0 0 40px 40px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      position: sticky; top: 0; z-index: 30;
    }
    .heroInner {
      max-width: 1100px; margin: 0 auto; padding: 0 20px;
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
    }
    .brandBox { display: flex; align-items: center; gap: 15px; }
    .logoRing {
      width: 55px; height: 55px; border-radius: 20px;
      background: var(--yellow);
      display: grid; place-items: center;
      box-shadow: 4px 4px 0px var(--accent);
      overflow: hidden;
      flex: 0 0 auto;
    }
    .logoRing img { width: 45px; height: 45px; object-fit: contain; display:block; }
    .brandText .t1 { font-family: 'Fredoka', sans-serif; font-size: 24px; font-weight: 800; color: var(--brand); line-height: 1; }
    .brandText .t2 { font-size: 14px; font-weight: 700; color: var(--muted); margin-top: 6px; }

    /* Pills */
    .pill {
      background: white; padding: 10px 18px; border-radius: 20px;
      border: 3px solid var(--brand-soft); font-weight: 800;
      display: inline-flex; align-items: center; gap: 8px;
      transition: all 0.2s; cursor: pointer;
      user-select:none;
      text-decoration:none;
      color: inherit;
      white-space: nowrap;
    }
    .pill:hover { transform: scale(1.05); background: var(--brand-soft); color: white; }
    .pill:active { transform: scale(0.98); }

    .card {
      background: white; border-radius: var(--radius);
      border: 4px solid #dfe6e9;
      padding: 25px;
      margin-top: 25px;
      transition: transform 0.3s;
      box-shadow: 0 14px 26px rgba(0,0,0,0.06);
    }
    .card:hover { transform: translateY(-5px); }

    h1 { font-size: 28px; color: var(--brand); margin: 0 0 10px 0; display: flex; align-items: center; gap: 10px; }
    .sub { font-size: 16px; font-weight: 700; color: var(--muted); margin-bottom: 20px; }

    .page{display:none}
    .page.active{display:block}

    .input-group { display: flex; gap: 10px; flex-wrap: wrap; align-items: stretch; }

    .input {
      flex: 1; min-width: 200px; padding: 15px 25px;
      border-radius: 25px; border: 4px solid var(--bg);
      background: var(--bg);
      font-size: 18px; font-weight: 800; outline: none;
    }
    .input:focus { border-color: var(--brand-soft); background: white; }

    #ansInput{
      font-size: var(--ansFont);
      padding: calc(14px * var(--gameScale)) calc(20px * var(--gameScale));
      letter-spacing: 0.2px;
    }
    #ansInput::placeholder{
      font-size: var(--ansFont);
      font-weight: 900;
      opacity: 0.92;
    }

    .btn {
      padding: 15px 30px; border-radius: 25px; border: none;
      font-size: 18px; font-weight: 900; cursor: pointer;
      display: inline-flex; align-items: center; gap: 10px;
      transition: all 0.2s; box-shadow: 0 6px 0px rgba(0,0,0,0.1);
      user-select:none;
    }
    .btn:active { transform: translateY(4px); box-shadow: none; }
    .btn-primary { background: var(--brand); color: white; }
    .btn-success { background: var(--green); color: #1e3799; }
    .btn-warning { background: var(--yellow); color: #d35400; }

    /* Level cards */
    .levelGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
    .levelCard {
      background: white; border: 4px solid #dfe6e9; border-radius: 25px;
      padding: 20px; cursor: pointer; transition: all 0.3s;
      user-select:none;
    }
    .levelCard.active { border-color: var(--brand); background: #f8f7ff; transform: scale(1.02); }
    .levelCard .icon {
      font-size: 40px; margin-bottom: 10px; color: var(--brand);
      background: var(--bg); width: 70px; height: 70px;
      display: grid; place-items: center; border-radius: 20px;
    }

    .chip{justify-content:center}
    .chip.active{outline:4px solid rgba(108,92,231,0.25)}

    /* HUD */
    .hud {
      display: flex; justify-content: space-around;
      background: var(--brand); border-radius: 25px; padding: 15px; color: white; margin-bottom: 20px;
      box-shadow: 0 14px 26px rgba(108,92,231,0.25);
      flex-wrap: wrap; gap: 12px;
    }
    .stat-box { text-align: center; min-width: 90px; }
    .stat-label { font-size: 12px; font-weight: 800; text-transform: uppercase; opacity: 0.9; }
    .stat-val { font-size: 24px; font-weight: 900; font-family: 'Fredoka'; }
    .timebar{
      width: min(360px, 100%);
      height: 14px;
      background: rgba(255,255,255,0.25);
      border-radius: 999px;
      overflow:hidden;
      align-self:center;
      border: 2px solid rgba(255,255,255,0.25);
    }
    .timefill{
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #55efc4, #fdcb6e, #fd79a8);
      transition: width .15s linear;
    }

    .game-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
    .row{display:flex; gap:10px; align-items:flex-start}

    #pageGame .q-bubble {
      background: #f1f2f6;
      border-radius: 22px;
      padding: var(--bubblePad);
      font-weight: 900;
      line-height: 1.55;
      border: 3px dashed var(--brand-soft);
      margin-bottom: 16px;
      flex: 1;
      font-size: var(--sceneFont);
    }

    #pageGame .math-display {
      font-family: 'Fredoka';
      font-weight: 900;
      color: var(--brand);
      text-align: center;
      text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
      word-break: break-word;
      letter-spacing: 1px;
      font-size: var(--mathFont);
      margin: var(--mathMarginTop) 0 var(--mathMarginBottom);
      line-height: 1.05;
    }
    #pageGame .math-display.cmp{
      letter-spacing: 2px;
      font-size: var(--mathFontCmp);
    }

    .feedback-area {
      min-height: 76px; padding: 14px; border-radius: 18px;
      text-align: center; font-weight: 800; font-size: 18px;
      margin: 14px 0; display: flex; flex-direction: column; justify-content: center;
      border: 3px solid #dfe6e9;
    }
    .feedback-area.correct { background: var(--green); color: #009432; border-color: rgba(0,148,50,0.25); }
    .feedback-area.wrong { background: var(--accent); color: #c0392b; border-color: rgba(192,57,43,0.25); }

    .ctrlRow{display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px}
    .ctrlRow .btn{flex:1; justify-content:center; min-width: 160px}

    /* Overlay */
    .overlay {
      position: fixed; inset: 0; background: rgba(108, 92, 231, 0.8);
      backdrop-filter: blur(8px); display: none; place-items: center; z-index: 100;
      padding: 16px;
    }
    .overlay.active { display: grid; }
    .modal {
      background: white; padding: 34px 26px; border-radius: 40px; text-align: center;
      max-width: 420px; width: 100%;
      border: 8px solid var(--yellow);
      box-shadow: 0 22px 60px rgba(0,0,0,0.25);
    }

    .tiny{font-size:13px; font-weight:800; color: var(--muted); margin-top: 10px;}
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: #f8f7ff;
      border: 3px solid #dfe6e9;
      font-weight: 900;
      color: var(--brand);
    }

    /* âœ… æ’è¡Œæ¦œè¡¨æ ¼ï¼ˆåªæ–°å¢ï¼Œä¸å½±éŸ¿å…¶ä»–å€å¡Šï¼‰ */
    .lbHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom: 12px;
    }
    .lbMeta{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      color: var(--muted);
      font-weight: 900;
      font-size: 14px;
    }
    .lbTable{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 18px;
      border: 3px solid #dfe6e9;
      background: #fff;
    }
    .lbTable th, .lbTable td{
      padding: 12px 10px;
      text-align: left;
      font-weight: 900;
      border-bottom: 2px solid #edf0f2;
      font-size: 14px;
    }
    .lbTable th{
      background:#f8f7ff;
      color: var(--brand);
      letter-spacing: 0.2px;
    }
    .lbTable tr:last-child td{ border-bottom: none; }
    .rankBadge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width: 28px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f1f2f6;
      border: 2px solid #dfe6e9;
      color: var(--ink);
      font-family: 'Fredoka', sans-serif;
    }
    .lbEmpty{
      padding: 14px;
      border-radius: 18px;
      border: 3px dashed var(--brand-soft);
      background: #f8f7ff;
      font-weight: 900;
      color: var(--muted);
      text-align:center;
    }

    @media (max-width: 520px){
      :root{
        --gameScale: 1.00;
        --sceneFont: clamp(18px, 2.2vw + 12px, 24px);
        --mathFont: clamp(52px, 7.0vw + 16px, 88px);
        --mathFontCmp: clamp(58px, 7.4vw + 16px, 96px);
        --ansFont: clamp(18px, 2.6vw + 12px, 24px);
      }
      .heroInner{padding: 0 14px}
      .brandText .t1{font-size:20px}
      h1{font-size:24px}
      .btn{font-size:16px; padding: 14px 18px}
      .pill{padding: 10px 14px}
      #ansInput{min-width: 100%;}
      .lbTable th, .lbTable td{ font-size: 13px; padding: 10px 8px; }
    }
  </style>
</head>

<body>
  <header class="hero">
    <div class="heroInner">
      <div class="brandBox">
        <div class="logoRing" title="Jessie Math">
          <img src="JESSIEMATH-Q.png" alt="Jessie Math Logoï¼ˆé€æ˜èƒŒæ™¯ï¼‰">
        </div>
        <div class="brandText">
          <div class="t1">Jessie Math</div>
          <div class="t2">æ•¸å­¸å†’éšªå³¶ï½œäºŒä½æ•¸æŒ‘æˆ°</div>
        </div>
      </div>

      <nav style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="pill" href="https://jessiemath0703-chu.github.io/website2/" target="_blank" rel="noopener">
          <i class="fa-solid fa-house"></i><span>é¦–é </span>
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/" target="_blank" rel="noopener">
          <i class="fa-solid fa-gamepad"></i><span>éŠæˆ²å¤§å»³</span>
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g2-u2" target="_blank" rel="noopener">
          <i class="fa-solid fa-arrow-rotate-left"></i><span>äºŒå¹´ç´šäºŒä½æ•¸çš„åŠ æ¸›æ³•</span>
        </a>
      </nav>
    </div>
  </header>

  <main class="wrap">

    <!-- PAGE: NAME -->
    <section id="pageName" class="page active">
      <div class="card">
        <h1><i class="fa-solid fa-wand-magic-sparkles"></i> å†’éšªè€…è«‹å ±å</h1>
        <div class="sub">æº–å‚™å¥½é€²å…¥ 60 ç§’æ•¸å­¸æŒ‘æˆ°äº†å—ï¼Ÿè¼¸å…¥ä½ çš„è‹±é›„ç¨±è™Ÿï¼</div>

        <div class="input-group">
          <input id="nameInput" class="input" type="text" placeholder="ä½ çš„åå­—..." maxlength="12" autocomplete="off">
          <button id="btnStartToMenu" class="btn btn-primary" type="button">é–‹å§‹æŒ‘æˆ° <i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div style="margin-top: 25px; background: #f8f9fa; padding: 15px; border-radius: 20px; font-size: 14px; font-weight: 700; color: #636e72;">
          ğŸŒˆ <b>è¦å‰‡ï¼š</b>æ¯å›åˆ 60 ç§’ã€‚ç­”å° <b>+5</b> ç§’ï¼Œç­”éŒ¯ <b>-5</b> ç§’ã€‚<br>
          ğŸ”¥ é€£çºŒç­”å°æœƒæœ‰ <b>Combo</b> åŠ æˆï¼Œåˆ†æ•¸æœƒè¶Šè¡è¶Šé«˜ï¼<br>
          ğŸ”Š é¡Œç›®ä¸æœƒè‡ªå‹•æœ—è®€ï¼šéœ€è¦æ™‚æŒ‰å–‡å­å†å”¸ã€‚
        </div>
      </div>
    </section>

    <!-- PAGE: MENU -->
    <section id="pageMenu" class="page">
      <div style="display:flex; justify-content: space-between; align-items:center; gap: 10px; flex-wrap:wrap;">
        <h1 style="margin:0;">âœ¨ é¸æ“‡å†’éšªåœ°åœ–</h1>
        <div class="pill" id="btnBackToName" role="button" tabindex="0"><i class="fa-solid fa-pen"></i>æ›åå­—</div>
      </div>

      <div class="sub">ä½ å¥½ï¼Œ<span id="playerNameLabel" style="color:var(--brand)">å†’éšªè€…</span>ï¼ä»Šå¤©è¦æŒ‘æˆ°å“ªä¸€é—œï¼Ÿï¼ˆç¢°åˆ°é—œå¡æœƒå¿µï¼‰</div>

      <div class="levelGrid">
        <div class="levelCard active" data-level="1" tabindex="0" aria-label="ç¬¬ä¸€é—œ åŠ æ³•ä¹‹æ£®">
          <div class="icon"><i class="fa-solid fa-plus"></i></div>
          <div style="font-weight: 900; font-size: 20px;">åŠ æ³•ä¹‹æ£®</div>
          <div style="font-size: 14px; color: var(--muted); font-weight: 700; margin-top: 5px;">é€²ä½çš„å°ç²¾éˆå‡ºæ²’ä¸­ï¼</div>
        </div>

        <div class="levelCard" data-level="2" tabindex="0" aria-label="ç¬¬äºŒé—œ æ¸›æ³•æ²™æ¼ ">
          <div class="icon"><i class="fa-solid fa-minus"></i></div>
          <div style="font-weight: 900; font-size: 20px;">æ¸›æ³•æ²™æ¼ </div>
          <div style="font-size: 14px; color: var(--muted); font-weight: 700; margin-top: 5px;">å€Ÿä½çš„æ°´é¾æ²æŒ‘æˆ°ï¼</div>
        </div>

        <div class="levelCard" data-level="3" tabindex="0" aria-label="ç¬¬ä¸‰é—œ æ¯”è¼ƒä¹‹å·”">
          <div class="icon"><i class="fa-solid fa-scale-balanced"></i></div>
          <div style="font-weight: 900; font-size: 20px;">æ¯”è¼ƒä¹‹å·”</div>
          <div style="font-size: 14px; color: var(--muted); font-weight: 700; margin-top: 5px;">ç­‰æ–¼ï¼Ÿå¤§æ–¼ï¼Ÿå°æ–¼ï¼Ÿç¬é–“çœ‹ç©¿ï¼</div>
        </div>
      </div>

      <div class="card">
        <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
          <div style="font-weight: 900;">èª¿æ•´é›£åº¦ï¼š</div>
          <div class="badge" id="diffBadge"><i class="fa-solid fa-leaf"></i><span>ç°¡å–®</span></div>
        </div>

        <div class="input-group" style="margin-top:12px;">
          <button class="btn btn-success chip active" type="button" data-diff="easy">ğŸŒ± ç°¡å–®</button>
          <button class="btn btn-warning chip" type="button" data-diff="normal">ğŸ”¥ æ™®é€š</button>
          <button class="btn btn-primary chip" type="button" data-diff="hard">ğŸ‰ å›°é›£</button>
        </div>

        <button id="btnStartGame" class="btn btn-primary" type="button"
          style="width: 100%; margin-top: 20px; justify-content: center; font-size: 22px;">
          å‡ºç™¼å†’éšªï¼ <i class="fa-solid fa-play"></i>
        </button>

        <div class="tiny">
          â€¢ é€²å…¥é—œå¡å¾Œï¼šEnter é€å‡ºç­”æ¡ˆã€‚ç­”å° +5 ç§’ï¼Œç­”éŒ¯ -5 ç§’ã€‚<br>
          â€¢ å›ä¸»é¸å–®ä¸å¯«å…¥æ’è¡Œæ¦œï¼ˆé¿å…äº‚æŒ‰æ´—æ¦œï¼‰ã€‚
        </div>
      </div>

      <!-- âœ… æ–°å¢ï¼šæ’è¡Œæ¦œï¼ˆæ”¾åœ¨é¸é—œå¡é ï¼‰ -->
      <div class="card">
        <div class="lbHead">
          <h1 style="margin:0;"><i class="fa-solid fa-trophy"></i> æ’è¡Œæ¦œ</h1>
          <div class="lbMeta">
            <span class="badge" id="lbModeBadge"><i class="fa-solid fa-flag"></i><span>ç¬¬ä¸€é—œï½œç°¡å–®</span></span>
            <button id="btnClearLB" class="pill" type="button" title="æ¸…ç©ºç›®å‰åˆ†æ¦œ">
              <i class="fa-solid fa-trash"></i><span>æ¸…ç©ºæœ¬åˆ†æ¦œ</span>
            </button>
          </div>
        </div>

        <div id="lbBox"></div>

        <div class="tiny">
          â€¢ åˆ†æ¦œè¦å‰‡ï¼šä¾ã€Œé—œå¡ï¼‹é›£åº¦ã€åˆ†é–‹æ’è¡Œã€‚<br>
          â€¢ åªæœ‰æ™‚é–“åˆ°çµæŸæ‰æœƒå¯«å…¥ï¼›å›ä¸»é¸å–®ä¸å¯«æ¦œã€‚
        </div>
      </div>
    </section>

    <!-- PAGE: GAME -->
    <section id="pageGame" class="page">
      <div class="hud">
        <div class="stat-box">
          <div class="stat-label">â³ æ™‚é–“</div>
          <div class="stat-val" id="timeLeft">60</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ğŸ† åˆ†æ•¸</div>
          <div class="stat-val" id="score">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">ğŸ”¥ Combo</div>
          <div class="stat-val" id="combo">0</div>
        </div>
        <div class="timebar" aria-label="æ™‚é–“æ¢"><div id="timeFill" class="timefill"></div></div>
      </div>

      <div class="game-layout">
        <div class="card" style="margin-top:0">
          <div class="row">
            <div class="q-bubble" id="sceneText">æ­£åœ¨å¬å–šé¡Œç›®ä¸­...</div>
            <button id="btnSpeakQ" class="pill" type="button" title="æŒ‰ä¸€ä¸‹æ‰å”¸é¡Œç›®ï¼ˆä¸æœƒè‡ªå‹•å”¸ï¼‰">
              <i class="fa-solid fa-volume-high"></i>
            </button>
          </div>

          <div class="math-display" id="qText">-- + -- = ?</div>

          <div class="input-group">
            <input id="ansInput" class="input" type="text" inputmode="numeric" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆï¼ˆæŒ‰ Enterï¼‰" autocomplete="off">
            <button id="btnSubmit" class="btn btn-primary" type="button">é€å‡º</button>
          </div>

          <div id="feedback" class="feedback-area">åŠ æ²¹ï¼æº–å‚™å¥½å°±é–‹å§‹å›‰ï¼</div>

          <div class="ctrlRow">
            <button id="btnRestart" class="btn btn-warning" type="button"><i class="fa-solid fa-rotate-right"></i> é‡ä¾†</button>
            <button id="btnPause" class="btn btn-warning" type="button"><i class="fa-solid fa-pause"></i> æš«åœ</button>
            <button id="btnBackMenu" class="btn btn-primary" type="button"><i class="fa-solid fa-door-open"></i> å›ä¸»é¸å–®</button>
          </div>

          <div class="tiny">
            â€¢ éœ€è¦èªéŸ³ï¼šæŒ‰å–‡å­ã€‚<br>
            â€¢ ç­”éŒ¯æœƒé¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆï¼ˆåˆ¥æ€•ï¼ŒéŒ¯èª¤åªæ˜¯é€šå¾€é«˜æ‰‹çš„æ·å¾‘ï¼‰ã€‚
          </div>
        </div>
      </div>
    </section>

  </main>

  <div id="overlay" class="overlay" aria-label="æš«åœé®ç½©" role="dialog" aria-modal="true">
    <div class="modal">
      <h1 style="justify-content:center;"><i class="fa-solid fa-couch"></i> ä¼‘æ¯ä¸€ä¸‹</h1>
      <p style="font-weight: 800; color: var(--muted); margin: 10px 0 0;">å–å£æ°´ï¼Œæ·±å‘¼å¸ï¼Œæº–å‚™å¥½äº†å†ç¹¼çºŒï¼</p>
      <button id="btnResume" class="btn btn-success" type="button" style="width: 100%; justify-content: center; margin-top: 14px;">
        ç¹¼çºŒå†’éšª <i class="fa-solid fa-play"></i>
      </button>
      <button id="btnPauseBack" class="btn btn-primary" type="button" style="width: 100%; justify-content: center; margin-top: 10px;">
        å›ä¸»é¸å–®ï¼ˆä¸å¯«æ¦œï¼‰ <i class="fa-solid fa-door-open"></i>
      </button>
    </div>
  </div>

  <script>
    const pageName = document.getElementById('pageName');
    const pageMenu = document.getElementById('pageMenu');
    const pageGame = document.getElementById('pageGame');

    const nameInput = document.getElementById('nameInput');
    const btnStartToMenu = document.getElementById('btnStartToMenu');
    const btnBackToName = document.getElementById('btnBackToName');
    const playerNameLabel = document.getElementById('playerNameLabel');

    const levelCards = Array.from(document.querySelectorAll('.levelCard'));
    const diffChips = Array.from(document.querySelectorAll('.chip'));
    const btnStartGame = document.getElementById('btnStartGame');
    const diffBadge = document.getElementById('diffBadge');

    const timeLeftEl = document.getElementById('timeLeft');
    const scoreEl = document.getElementById('score');
    const comboEl = document.getElementById('combo');
    const timeFill = document.getElementById('timeFill');

    const sceneText = document.getElementById('sceneText');
    const qText = document.getElementById('qText');
    const ansInput = document.getElementById('ansInput');
    const btnSubmit = document.getElementById('btnSubmit');
    const feedback = document.getElementById('feedback');
    const btnSpeakQ = document.getElementById('btnSpeakQ');

    const btnPause = document.getElementById('btnPause');
    const btnRestart = document.getElementById('btnRestart');
    const btnBackMenu = document.getElementById('btnBackMenu');

    const overlay = document.getElementById('overlay');
    const btnResume = document.getElementById('btnResume');
    const btnPauseBack = document.getElementById('btnPauseBack');

    /* âœ… æ’è¡Œæ¦œå…ƒç´ ï¼ˆæ–°å¢ï¼‰ */
    const lbBox = document.getElementById('lbBox');
    const lbModeBadge = document.getElementById('lbModeBadge');
    const btnClearLB = document.getElementById('btnClearLB');

    const canSpeak = ('speechSynthesis' in window);

    const STATE = {
      name: '',
      level: 1,
      diff: 'easy',
      running: false,
      paused: false,
      timeLeft: 60,
      score: 0,
      combo: 0,
      multiplier: 1,
      timer: null,
      current: null,
      allowWrite: true,
      lockAnswer: false,
      nextDelayMs: 850
    };

    const DIFF = {
      easy:   { label: 'ç°¡å–®', icon:'fa-leaf', maxA: 39, maxB: 29, carryChance: 0.35, borrowChance: 0.35, compareMax: 59, basePts: 10, multStep: 3 },
      normal: { label: 'æ™®é€š', icon:'fa-fire', maxA: 69, maxB: 59, carryChance: 0.55, borrowChance: 0.55, compareMax: 89, basePts: 12, multStep: 2 },
      hard:   { label: 'å›°é›£', icon:'fa-dragon', maxA: 99, maxB: 99, carryChance: 0.75, borrowChance: 0.75, compareMax: 99, basePts: 14, multStep: 2 }
    };

    const LEVELS = {
      1: { speak: 'ç¬¬ä¸€é—œï¼ŒåŠ æ³•ä¹‹æ£®', title: 'ç¬¬ä¸€é—œ' },
      2: { speak: 'ç¬¬äºŒé—œï¼Œæ¸›æ³•æ²™æ¼ ', title: 'ç¬¬äºŒé—œ' },
      3: { speak: 'ç¬¬ä¸‰é—œï¼Œæ¯”è¼ƒä¹‹å·”', title: 'ç¬¬ä¸‰é—œ' }
    };

    const clamp = (n,a,b)=>Math.max(a, Math.min(b,n));
    const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    const normName = (s)=>(s||'').trim().replace(/\s+/g,' ').slice(0,12);

    function switchPage(p){
      [pageName,pageMenu,pageGame].forEach(x=>x.classList.remove('active'));
      p.classList.add('active');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function speak(text){
      if(!canSpeak) return;
      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.rate = 1.05;
        u.pitch = 1.05;
        window.speechSynthesis.speak(u);
      }catch(e){}
    }

    function updateDiffBadge(){
      const d = DIFF[STATE.diff];
      diffBadge.innerHTML = `<i class="fa-solid ${d.icon}"></i><span>${d.label}</span>`;
    }

    function setLevel(lvl){
      STATE.level = Number(lvl);
      levelCards.forEach(c=>c.classList.toggle('active', Number(c.dataset.level)===STATE.level));
      updateLeaderboardUI(); /* âœ… æ–°å¢ï¼šåˆ‡æ›é—œå¡å°±æ›´æ–°æ’è¡Œæ¦œ */
    }

    function setDiff(diff){
      STATE.diff = diff;
      diffChips.forEach(c=>c.classList.toggle('active', c.dataset.diff===diff));
      updateDiffBadge();
      updateLeaderboardUI(); /* âœ… æ–°å¢ï¼šåˆ‡æ›é›£åº¦å°±æ›´æ–°æ’è¡Œæ¦œ */
    }

    function updateMultiplier(){
      const step = DIFF[STATE.diff].multStep;
      const tier = Math.floor(STATE.combo / step);
      STATE.multiplier = clamp(1 + tier*0.25, 1, 2.5);
    }

    function renderHUD(){
      timeLeftEl.textContent = STATE.timeLeft;
      scoreEl.textContent = STATE.score;
      comboEl.textContent = STATE.combo;
      const pct = clamp((STATE.timeLeft/60)*100, 0, 100);
      timeFill.style.width = pct + '%';
    }

    /* =========================
       âœ… æ’è¡Œæ¦œï¼ˆæ–°å¢ï¼Œä½†ä¸å‹•åŸç©æ³•ï¼‰
       ========================= */
    const LB_PREFIX = 'JM_G2U2_LB_v1';
    function lbKey(){
      return `${LB_PREFIX}_L${STATE.level}_${STATE.diff}`;
    }
    function loadLB(){
      try{
        const raw = localStorage.getItem(lbKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }
    function saveLB(arr){
      try{ localStorage.setItem(lbKey(), JSON.stringify(arr)); }catch(e){}
    }
    function addToLB(name, score){
      const now = Date.now();
      const item = { name: (name||'å†’éšªè€…').slice(0,12), score: Number(score)||0, ts: now };
      const arr = loadLB();
      arr.push(item);
      arr.sort((a,b)=> (b.score - a.score) || (a.ts - b.ts));
      const top = arr.slice(0,10);
      saveLB(top);
    }
    function fmtDiff(d){ return (DIFF[d]?.label) || 'â€”'; }
    function updateLeaderboardUI(){
      if(!lbBox) return;
      const lvlTitle = LEVELS[STATE.level]?.title || `ç¬¬${STATE.level}é—œ`;
      const diffTitle = fmtDiff(STATE.diff);

      lbModeBadge.innerHTML = `<i class="fa-solid fa-flag"></i><span>${lvlTitle}ï½œ${diffTitle}</span>`;

      const arr = loadLB();
      if(!arr.length){
        lbBox.innerHTML = `<div class="lbEmpty">é€™å€‹åˆ†æ¦œé‚„æ²’æœ‰äººç•™ä¸‹è¶³è·¡ï½å¿«ç”¨åˆ†æ•¸å¯«ä¸€é¦–å‚³èªª âœ¨</div>`;
        return;
      }

      const rows = arr.map((r, idx)=>{
        const n = String(r.name || 'å†’éšªè€…');
        const s = Number(r.score||0);
        return `
          <tr>
            <td style="width:90px;"><span class="rankBadge">${idx+1}</span></td>
            <td>${escapeHtml(n)}</td>
            <td style="width:120px; font-family:Fredoka; font-size:16px;">${s}</td>
          </tr>
        `;
      }).join('');

      lbBox.innerHTML = `
        <table class="lbTable" aria-label="æ’è¡Œæ¦œ">
          <thead>
            <tr>
              <th style="width:90px;">åæ¬¡</th>
              <th>åå­—</th>
              <th style="width:120px;">åˆ†æ•¸</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    btnClearLB.addEventListener('click', ()=>{
      try{ localStorage.removeItem(lbKey()); }catch(e){}
      updateLeaderboardUI();
    });

    /* =========================
       é¡Œç›®ç”Ÿæˆï¼ˆåŸæœ¬é‚è¼¯ä¿ç•™ï¼‰
       ========================= */
    function makeCarryPair(maxA, maxB, carryChance){
      let A,B;
      const force = Math.random() < carryChance;
      if(force){
        const aT=randInt(1,9), bT=randInt(1,9);
        const aO=randInt(5,9), bO=randInt(5,9);
        A=aT*10+aO; B=bT*10+bO;
      }else{
        A=randInt(10,maxA); B=randInt(10,maxB);
      }
      return [A,B];
    }

    function makeBorrowPair(maxA, maxB, borrowChance){
      let A,B;
      const force = Math.random() < borrowChance;
      if(force){
        const aT=randInt(2,9);
        const bT=randInt(1,aT);
        const aO=randInt(0,4);
        const bO=randInt(5,9);
        A=aT*10+aO;
        B=bT*10+bO;
        if(B>=A) A+=10;
      }else{
        A=randInt(20, Math.min(99, maxA+30));
        B=randInt(10, Math.min(maxB, A-1));
      }
      A=clamp(A,10,99);
      B=clamp(B,1,A-1);
      return [A,B];
    }

    const STORY = {
      add: [
        {tag:'æ—©é¤åº—', unit:'å€‹', a:'æ°´é¤ƒ', b:'é‹è²¼'},
        {tag:'åœ–æ›¸è§’', unit:'æœ¬', a:'æ•…äº‹æ›¸', b:'ç™¾ç§‘æ›¸'},
        {tag:'é»å¿ƒè»Š', unit:'åŒ…', a:'é¤…ä¹¾', b:'ç³–æœ'},
        {tag:'æ–‡å…·åº—', unit:'æ”¯', a:'é‰›ç­†', b:'å½©è‰²ç­†'},
        {tag:'è²¼ç´™å±‹', unit:'å¼µ', a:'è²¼ç´™', b:'æ˜Ÿæ˜Ÿè²¼ç´™'},
        {tag:'éŠæˆ²ä»£å¹£ç«™', unit:'æš', a:'ä»£å¹£', b:'é‡‘å¹£'},
        {tag:'å°å°è¾²å ´', unit:'é¡†', a:'è˜‹æœ', b:'é¦™è•‰'},
        {tag:'é›¶é£Ÿè£œçµ¦', unit:'åŒ…', a:'æµ·è‹”', b:'æœå‡'}
      ],
      sub: [
        {tag:'ç³–æœç½', unit:'é¡†', item:'ç³–æœ'},
        {tag:'è²¼ç´™æ”¶è—', unit:'å¼µ', item:'è²¼ç´™'},
        {tag:'é›¶é£Ÿç®±', unit:'åŒ…', item:'é¤…ä¹¾'},
        {tag:'æ–‡å…·ç›’', unit:'æ', item:'é‰›ç­†'},
        {tag:'éŠæˆ²ä»£å¹£', unit:'æš', item:'ä»£å¹£'},
        {tag:'æ°´æœç±ƒ', unit:'é¡†', item:'è˜‹æœ'},
        {tag:'ç©æœ¨ç®±', unit:'å¡Š', item:'ç©æœ¨'},
        {tag:'å°è±¬æ’²æ»¿', unit:'å…ƒ', item:'éŒ¢'}
      ]
    };

    function makeAdd(){
      const d = DIFF[STATE.diff];
      const [A,B] = makeCarryPair(d.maxA, d.maxB, d.carryChance);
      const type = pick(['plain','story','missing1','missing2','money']);
      const sum = A + B;

      if(type==='plain'){
        const scene = `ç›´å¼åŠ æ³•ï¼šç®—ä¸€ç®—ç­”æ¡ˆã€‚`;
        return { scene, expr: `${A} + ${B} = ?`, answer: String(sum), speak: `è«‹è¨ˆç®—ï¼Œ${A} åŠ  ${B} ç­‰æ–¼å¤šå°‘ï¼Ÿ` };
      }
      if(type==='missing1'){
        const scene = `å¡«ç©ºæŒ‘æˆ°ï¼šæŠŠç©ºæ ¼è£œèµ·ä¾†ã€‚`;
        return { scene, expr: `${A} + â–¡ = ${sum}`, answer: String(B), speak: `å¡«ç©ºé¡Œï¼Œ${A} åŠ å¤šå°‘ç­‰æ–¼ ${sum}ï¼Ÿ` };
      }
      if(type==='missing2'){
        const scene = `å¡«ç©ºæŒ‘æˆ°ï¼šæŠŠç©ºæ ¼è£œèµ·ä¾†ã€‚`;
        return { scene, expr: `â–¡ + ${B} = ${sum}`, answer: String(A), speak: `å¡«ç©ºé¡Œï¼Œå¤šå°‘åŠ  ${B} ç­‰æ–¼ ${sum}ï¼Ÿ` };
      }
      if(type==='money'){
        const base = clamp(A, 10, 99);
        const add = clamp(B, 10, 99);
        const total = base + add;
        const scene = `é›¶ç”¨éŒ¢ï¼šä½ åŸæœ‰ ${base} å…ƒï¼Œåˆå¾—åˆ° ${add} å…ƒï¼Œç¾åœ¨å…±æœ‰å¤šå°‘å…ƒï¼Ÿ`;
        return { scene, expr: `${base} + ${add} = ?`, answer: String(total), speak: `é›¶ç”¨éŒ¢é¡Œï¼Œ${base} å…ƒå†åŠ  ${add} å…ƒï¼Œä¸€å…±æœ‰å¤šå°‘å…ƒï¼Ÿ` };
      }
      const ctx = pick(STORY.add);
      const scene = `åœ¨${ctx.tag}ï¼šä½ æœ‰ ${A}${ctx.unit}${ctx.a}ï¼Œåˆå¾—åˆ° ${B}${ctx.unit}${ctx.b}ï¼Œä¸€å…±æœ‰å¤šå°‘${ctx.unit}ï¼Ÿ`;
      return { scene, expr: `${A} + ${B} = ?`, answer: String(sum), speak: scene };
    }

    function makeSub(){
      const d = DIFF[STATE.diff];
      const [Araw,Braw] = makeBorrowPair(d.maxA, d.maxB, d.borrowChance);
      let A=Araw, B=Braw;
      const type = pick(['plain','story','missing1','missing2','money']);
      const diff = A - B;

      if(type==='plain'){
        const scene = `ç›´å¼æ¸›æ³•ï¼šç®—ä¸€ç®—ç­”æ¡ˆã€‚`;
        return { scene, expr: `${A} âˆ’ ${B} = ?`, answer: String(diff), speak: `è«‹è¨ˆç®—ï¼Œ${A} æ¸› ${B} ç­‰æ–¼å¤šå°‘ï¼Ÿ` };
      }
      if(type==='missing1'){
        const scene = `å¡«ç©ºæŒ‘æˆ°ï¼šæŠŠç©ºæ ¼è£œèµ·ä¾†ã€‚`;
        return { scene, expr: `${A} âˆ’ â–¡ = ${diff}`, answer: String(B), speak: `å¡«ç©ºé¡Œï¼Œ${A} æ¸›å¤šå°‘ç­‰æ–¼ ${diff}ï¼Ÿ` };
      }
      if(type==='missing2'){
        const C = diff + B;
        const scene = `å¡«ç©ºæŒ‘æˆ°ï¼šæŠŠç©ºæ ¼è£œèµ·ä¾†ã€‚`;
        return { scene, expr: `â–¡ âˆ’ ${B} = ${diff}`, answer: String(C), speak: `å¡«ç©ºé¡Œï¼Œå¤šå°‘æ¸› ${B} ç­‰æ–¼ ${diff}ï¼Ÿ` };
      }
      if(type==='money'){
        const base = clamp(A, 10, 99);
        const spend = clamp(B, 10, base-1);
        const left = base - spend;
        const scene = `è²·æ±è¥¿ï¼šä½ æœ‰ ${base} å…ƒï¼ŒèŠ±äº† ${spend} å…ƒï¼Œé‚„å‰©å¤šå°‘å…ƒï¼Ÿ`;
        return { scene, expr: `${base} âˆ’ ${spend} = ?`, answer: String(left), speak: `è²·æ±è¥¿é¡Œï¼Œ${base} å…ƒèŠ±æ‰ ${spend} å…ƒï¼Œé‚„å‰©å¤šå°‘å…ƒï¼Ÿ` };
      }
      const ctx = pick(STORY.sub);
      if(ctx.item==='éŒ¢'){
        const base = clamp(A, 10, 99);
        const spend = clamp(B, 10, base-1);
        const left = base - spend;
        const scene = `åœ¨${ctx.tag}ï¼šä½ åŸæœ¬æœ‰ ${base}${ctx.unit}ï¼Œç”¨æ‰ ${spend}${ctx.unit}ï¼Œé‚„å‰©å¤šå°‘${ctx.unit}ï¼Ÿ`;
        return { scene, expr: `${base} âˆ’ ${spend} = ?`, answer: String(left), speak: scene };
      }else{
        const scene = `åœ¨${ctx.tag}ï¼šä½ åŸæœ¬æœ‰ ${A}${ctx.unit}${ctx.item}ï¼Œé€å‡º ${B}${ctx.unit}ï¼Œé‚„å‰©å¤šå°‘${ctx.unit}ï¼Ÿ`;
        return { scene, expr: `${A} âˆ’ ${B} = ?`, answer: String(diff), speak: scene };
      }
    }

    function makeCmp(){
      const d = DIFF[STATE.diff];
      const max = d.compareMax;
      const sceneBase = `åœ¨æ¯”è¼ƒä¹‹å·”ï¼šè«‹åœ¨ç©ºæ ¼å¡«å…¥ >ã€< æˆ– =ã€‚`;

      function cmpSymbol(x,y){ return (x>y)?'>':(x<y)?'<':'='; }
      function safe2(n){ return clamp(n, 0, max); }

      const mode = pick(['num','exprVsNum','exprVsExpr','sumVsNum','subVsNum']);

      if(mode==='num'){
        let A = randInt(0,max);
        let B = randInt(0,max);
        if(Math.random()<0.35) B = safe2(A + pick([-3,-2,-1,1,2,3]));
        const ans = cmpSymbol(A,B);
        const speakText = `è«‹å¡«å…¥å¤§æ–¼ã€å°æ–¼æˆ–ç­‰æ–¼ã€‚${A} å’Œ ${B}ï¼Œç©ºæ ¼è¦å¡«ä»€éº¼ï¼Ÿ`;
        return { scene: sceneBase, expr: `${A} â–¡ ${B}`, answer: ans, speak: speakText, cmpHint: `${A} ${ans} ${B}` };
      }

      if(mode==='exprVsNum'){
        let a = randInt(6, 29);
        let b = randInt(1, 29);
        let left = a + b;
        if(left>max) { a = Math.max(0, a-10); left = a+b; }
        let right = randInt(0, max);
        if(Math.random()<0.55) right = safe2(left + pick([-5,-3,-2,-1,0,1,2,3,5]));
        const ans = cmpSymbol(left, right);
        const speakText = `æ¯”è¼ƒç®—å¼çµæœã€‚${a} åŠ  ${b} å’Œ ${right}ï¼Œç©ºæ ¼è¦å¡«ä»€éº¼ï¼Ÿ`;
        return { scene: sceneBase, expr: `${a}+${b} â–¡ ${right}`, answer: ans, speak: speakText, cmpHint: `${left} ${ans} ${right}` };
      }

      if(mode==='sumVsNum'){
        let A = randInt(10, Math.min(max, 49));
        let B = randInt(1, Math.min(max, 49));
        const L = A+B;
        let C = safe2(L + pick([-8,-5,-3,-2,-1,0,1,2,3,5,8]));
        const ans = cmpSymbol(L, C);
        const speakText = `å…ˆç®—å·¦é‚Šå†æ¯”è¼ƒã€‚${A} åŠ  ${B} å’Œ ${C}ï¼Œç©ºæ ¼è¦å¡«ä»€éº¼ï¼Ÿ`;
        return { scene: sceneBase, expr: `${A}+${B} â–¡ ${C}`, answer: ans, speak: speakText, cmpHint: `${L} ${ans} ${C}` };
      }

      if(mode==='subVsNum'){
        let A = randInt(20, max);
        let B = randInt(1, Math.min(29, A));
        const L = A-B;
        let C = safe2(L + pick([-8,-5,-3,-2,-1,0,1,2,3,5,8]));
        const ans = cmpSymbol(L, C);
        const speakText = `å…ˆç®—å·¦é‚Šå†æ¯”è¼ƒã€‚${A} æ¸› ${B} å’Œ ${C}ï¼Œç©ºæ ¼è¦å¡«ä»€éº¼ï¼Ÿ`;
        return { scene: sceneBase, expr: `${A}âˆ’${B} â–¡ ${C}`, answer: ans, speak: speakText, cmpHint: `${L} ${ans} ${C}` };
      }

      let a = randInt(6, 39), b = randInt(1, 39);
      let c = randInt(6, 39), e = randInt(1, 39);
      let L = a+b, R = c+e;
      if(L>max){ a = Math.max(0,a-10); L=a+b; }
      if(R>max){ c = Math.max(0,c-10); R=c+e; }
      if(Math.random()<0.5){
        const target = safe2(L + pick([-3,-2,-1,0,1,2,3]));
        R = target;
        e = randInt(1, Math.min(39, R));
        c = R - e;
        if(c<0){ c = 0; e = R; }
      }
      L = a+b; R = c+e;
      const ans = cmpSymbol(L,R);
      const speakText = `æ¯”è¼ƒå…©å€‹ç®—å¼ã€‚${a} åŠ  ${b} å’Œ ${c} åŠ  ${e}ï¼Œç©ºæ ¼è¦å¡«ä»€éº¼ï¼Ÿ`;
      return { scene: sceneBase, expr: `${a}+${b} â–¡ ${c}+${e}`, answer: ans, speak: speakText, cmpHint: `${L} ${ans} ${R}` };
    }

    function lockAnswerUI(lock){
      STATE.lockAnswer = !!lock;
      ansInput.disabled = lock;
      btnSubmit.disabled = lock;
      ansInput.style.opacity = lock ? 0.7 : 1;
      btnSubmit.style.opacity = lock ? 0.7 : 1;
    }

    function nextQuestion(){
      let q;
      if(STATE.level===1) q = makeAdd();
      else if(STATE.level===2) q = makeSub();
      else q = makeCmp();

      STATE.current = q;
      sceneText.textContent = q.scene;

      if(STATE.level===3) qText.classList.add('cmp');
      else qText.classList.remove('cmp');

      qText.textContent = q.expr;

      if(STATE.level===3){
        ansInput.placeholder = 'è¼¸å…¥ > æˆ– < æˆ– =ï¼ˆæŒ‰ Enterï¼‰';
        ansInput.inputMode = 'text';
      }else{
        ansInput.placeholder = 'è«‹è¼¸å…¥ç­”æ¡ˆï¼ˆæŒ‰ Enterï¼‰';
        ansInput.inputMode = 'numeric';
      }
      ansInput.value = '';

      feedback.classList.remove('correct','wrong');
      feedback.textContent = 'å‡ºæ‰‹å§ï¼ç­”å°åŠ ç§’ã€ç­”éŒ¯æ‰£ç§’ï¼Œæ™‚é–“åœ¨ä½ æ‰‹ä¸Šã€‚';

      lockAnswerUI(false);
      setTimeout(()=>ansInput.focus(), 50);
    }

    function startTimer(){
      stopTimer();
      STATE.timer = setInterval(()=>{
        if(!STATE.running || STATE.paused) return;
        STATE.timeLeft -= 1;
        if(STATE.timeLeft<=0){
          STATE.timeLeft = 0;
          renderHUD();
          endGame(); /* æ™‚é–“åˆ°æ‰çµæŸ & æ‰å¯«æ¦œ */
          return;
        }
        renderHUD();
      }, 1000);
    }
    function stopTimer(){
      if(STATE.timer){
        clearInterval(STATE.timer);
        STATE.timer = null;
      }
    }

    function beginGame(){
      STATE.running = true;
      STATE.paused = false;
      STATE.allowWrite = true;

      STATE.timeLeft = 60;
      STATE.score = 0;
      STATE.combo = 0;
      updateMultiplier();
      renderHUD();

      feedback.classList.remove('correct','wrong');
      feedback.textContent = '60 ç§’é–‹å§‹ï¼ä½ æ˜¯æ™‚é–“çš„ä¸»äººï¼ˆè‡³å°‘é€™ä¸€åˆ†é˜æ˜¯ï¼‰ã€‚';

      nextQuestion();
      startTimer();
    }

    function endGame(){
      STATE.running = false;
      STATE.paused = false;
      stopTimer();
      overlay.classList.remove('active');
      lockAnswerUI(true);

      /* âœ… æ–°å¢ï¼šåªæœ‰æ­£å¸¸çµæŸæ‰å¯«å…¥æ’è¡Œæ¦œï¼ˆå›ä¸»é¸å–®ä¸å¯«æ¦œçš„è¦å‰‡ä¿ç•™ï¼‰ */
      if(STATE.allowWrite){
        addToLB(STATE.name, STATE.score);
        updateLeaderboardUI();
      }

      feedback.classList.remove('correct','wrong');
      feedback.innerHTML = `
        <div style="font-size:20px; font-weight:900; color:var(--brand);">æœ¬å±€çµæŸï¼</div>
        <div style="margin-top:8px; font-size:22px; font-weight:900;">ä½ çš„åˆ†æ•¸ï¼š<span style="font-family:Fredoka">${STATE.score}</span></div>
        <div class="tiny" style="margin-top:8px;">æƒ³å†åˆ·ä¸€æ¬¡ï¼ŸæŒ‰ã€Œé‡ä¾†ã€ç«‹åˆ»å†æˆ°ã€‚</div>
      `;
    }

    function pauseGame(){
      if(!STATE.running) return;
      STATE.paused = true;
      overlay.classList.add('active');
      btnPause.innerHTML = `<i class="fa-solid fa-play"></i> ç¹¼çºŒ`;
    }
    function resumeGame(){
      if(!STATE.running) return;
      STATE.paused = false;
      overlay.classList.remove('active');
      btnPause.innerHTML = `<i class="fa-solid fa-pause"></i> æš«åœ`;
      setTimeout(()=>ansInput.focus(), 50);
    }

    function backToMenu(){
      STATE.running = false;
      STATE.paused = false;
      STATE.allowWrite = false; /* é‡è¦ï¼šå›ä¸»é¸å–®ä¸å¯«æ¦œ */
      stopTimer();
      overlay.classList.remove('active');
      btnPause.innerHTML = `<i class="fa-solid fa-pause"></i> æš«åœ`;
      lockAnswerUI(false);
      switchPage(pageMenu);
      updateLeaderboardUI();
    }

    function restartSame(){
      STATE.running = false;
      STATE.paused = false;
      stopTimer();
      overlay.classList.remove('active');
      btnPause.innerHTML = `<i class="fa-solid fa-pause"></i> æš«åœ`;
      switchPage(pageGame);
      beginGame();
    }

    function submitAnswer(){
      if(!STATE.running || STATE.paused || !STATE.current) return;
      if(STATE.lockAnswer) return;

      const raw = (ansInput.value||'').trim();
      if(!raw){
        feedback.classList.remove('correct','wrong');
        feedback.textContent = 'å…ˆè¼¸å…¥ç­”æ¡ˆï½ä½ å¯ä»¥åšåˆ°çš„ã€‚';
        ansInput.focus();
        return;
      }

      const q = STATE.current;
      let ok = false;

      if(STATE.level===3){
        const v = raw.replace(/\s+/g,'');
        ok = (v === q.answer);
      }else{
        const n = Number(raw);
        ok = Number.isFinite(n) && n === Number(q.answer);
      }

      lockAnswerUI(true);

      if(ok){
        STATE.combo += 1;
        updateMultiplier();
        const pts = Math.round(DIFF[STATE.diff].basePts * STATE.multiplier);
        STATE.score += pts;
        STATE.timeLeft = clamp(STATE.timeLeft + 5, 0, 120);

        feedback.classList.remove('wrong');
        feedback.classList.add('correct');
        feedback.innerHTML = `âœ… ç­”å°ï¼<b>+${pts}</b> åˆ†ã€<b>+5</b> ç§’ã€‚<div class="tiny" style="margin-top:6px;">æ¼‚äº®ï½ç¯€å¥æŠ“ä½äº†ã€‚</div>`;
        renderHUD();
      }else{
        STATE.combo = 0;
        updateMultiplier();
        STATE.timeLeft = clamp(STATE.timeLeft - 5, 0, 120);

        feedback.classList.remove('correct');
        feedback.classList.add('wrong');

        const hint = (STATE.level===3 && q.cmpHint) ? `æ­£ç¢ºï¼š${q.cmpHint}` : `æ­£ç¢ºç­”æ¡ˆï¼š${q.answer}`;
        feedback.innerHTML = `âŒ ç­”éŒ¯äº†ï¼<b>-5</b> ç§’ã€‚<div class="tiny" style="margin-top:6px;">${hint}</div>`;
        renderHUD();
      }

      if(STATE.timeLeft<=0){
        STATE.timeLeft = 0;
        renderHUD();
        endGame();
        return;
      }

      setTimeout(()=>{
        if(!STATE.running) return;
        nextQuestion();
      }, STATE.nextDelayMs);
    }

    function bindLevelSpeak(){
      levelCards.forEach(card=>{
        const lvl = Number(card.dataset.level);
        const say = ()=> speak(LEVELS[lvl].speak);

        card.addEventListener('mouseenter', say);
        card.addEventListener('focus', say);
        card.addEventListener('click', ()=>{
          setLevel(lvl);
          say();
        });
        card.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' || e.key===' '){
            e.preventDefault();
            setLevel(lvl);
            say();
          }
        });
      });
    }

    btnStartToMenu.addEventListener('click', ()=>{
      const nm = normName(nameInput.value);
      if(!nm){ nameInput.focus(); return; }
      STATE.name = nm;
      playerNameLabel.textContent = nm;
      switchPage(pageMenu);
      updateLeaderboardUI(); /* âœ… é€²é¸å–®å°±è¼‰å…¥æ’è¡Œæ¦œ */
    });
    nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnStartToMenu.click(); });

    btnBackToName.addEventListener('click', ()=>{
      switchPage(pageName);
      setTimeout(()=>nameInput.focus(), 80);
    });
    btnBackToName.addEventListener('keydown', (e)=>{ if(e.key==='Enter') btnBackToName.click(); });

    diffChips.forEach(ch=> ch.addEventListener('click', ()=> setDiff(ch.dataset.diff)));

    btnStartGame.addEventListener('click', ()=>{
      if(!STATE.name){ switchPage(pageName); setTimeout(()=>nameInput.focus(), 80); return; }
      switchPage(pageGame);
      beginGame();
    });

    btnSubmit.addEventListener('click', submitAnswer);
    ansInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submitAnswer(); } });

    btnSpeakQ.addEventListener('click', ()=>{
      if(!STATE.current) return;
      if(!canSpeak){ feedback.textContent = 'é€™å°è£ç½®å¥½åƒä¸æ”¯æ´èªéŸ³æœ—è®€ï½'; return; }
      speak(STATE.current.speak);
    });

    btnPause.addEventListener('click', ()=>{
      if(!STATE.running) return;
      if(STATE.paused) resumeGame(); else pauseGame();
    });
    btnResume.addEventListener('click', resumeGame);

    btnRestart.addEventListener('click', restartSame);

    btnBackMenu.addEventListener('click', backToMenu);
    btnPauseBack.addEventListener('click', backToMenu);

    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        if(overlay.classList.contains('active')) resumeGame();
        else if(STATE.running) pauseGame();
      }
    });

    (function init(){
      setLevel(1);
      setDiff('easy');
      bindLevelSpeak();
      updateLeaderboardUI();
      setTimeout(()=>nameInput.focus(), 100);
    })();
  </script>
</body>
</html>




