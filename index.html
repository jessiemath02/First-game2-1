<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Jessie Math - 200 ä»¥å…§çš„æ•¸</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root{
      --bg:#f8faff;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;

      --brand:#5f73ff;
      --brand2:#eef2ff;
      --pink:#fb7185;
      --yellow:#f59e0b;
      --green:#10b981;
      --red:#f43f5e;

      --shadow-sm:0 4px 10px rgba(15,23,42,.08);
      --shadow:0 14px 40px rgba(15,23,42,.10);
      --shadow-lg:0 24px 60px rgba(15,23,42,.14);

      --radius:24px;
      --radius-sm:14px;
      --tap:54px;
    }

    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0;}
    body{
      font-family:"Noto Sans TC","Plus Jakarta Sans",system-ui,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(circle at 0% 0%, rgba(95,115,255,.10), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(251,113,133,.10), transparent 55%),
        var(--bg);
      line-height:1.5;
    }

    /* ========== HERO/NAV ========== */
    .nav{
      position:sticky; top:0; z-index:100;
      background:rgba(255,255,255,.84);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--line);
    }
    .nav-inner{
      max-width:1200px; margin:0 auto; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width: 220px;
    }
    .logoWrap{
      width:46px; height:46px;
      border-radius:14px;
      background:linear-gradient(135deg, rgba(255,215,0,.55), rgba(255,215,0,.15));
      display:grid; place-items:center;
      box-shadow: 0 10px 18px rgba(245,158,11,.18);
      border:1px solid rgba(245,158,11,.25);
      overflow:hidden;
    }
    .logoWrap img{
      width:40px; height:40px; object-fit:contain;
      filter: drop-shadow(0 6px 10px rgba(15,23,42,.12));
    }
    .brandInfo h1{
      margin:0;
      font-family:"Fredoka","Noto Sans TC",sans-serif;
      font-size:18px;
      letter-spacing:-.2px;
      font-weight:800;
      line-height:1.1;
    }
    .brandInfo p{
      margin:2px 0 0;
      color:var(--muted);
      font-weight:700;
      font-size:12px;
    }

    .navLinks{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 14px;
      border-radius:999px;
      background:#fff;
      border:1px solid var(--line);
      box-shadow:var(--shadow-sm);
      font-weight:800;
      font-size:13px;
      color:var(--ink);
      text-decoration:none;
      transition:.2s;
      user-select:none;
    }
    .pill:hover{transform: translateY(-1px); border-color: rgba(95,115,255,.55); color:var(--brand);}
    .pill:active{transform: translateY(0px) scale(.98);}

    /* ========== LAYOUT ========== */
    .wrap{max-width:1200px; margin:0 auto; padding:22px 16px 44px;}
    .page{display:none; animation: up .35s ease-out;}
    .page.active{display:block;}
    @keyframes up{from{opacity:0; transform:translateY(14px)} to{opacity:1; transform:translateY(0)}}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-bottom:18px;
    }
    .cardHead{
      padding:22px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(to right, #fff, var(--brand2));
    }
    .cardHead h2{margin:0; font-size:20px; font-weight:900;}
    .cardHead p{margin:8px 0 0; color:var(--muted); font-weight:600;}
    .cardBody{padding:22px;}

    .grid2{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px;}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr;} }

    /* ========== FORM ========== */
    .label{display:block; margin-bottom:8px; font-weight:900; font-size:14px;}
    .input, .select{
      width:100%;
      height:var(--tap);
      border-radius:16px;
      border:2px solid var(--line);
      background:#fff;
      padding:0 14px;
      font-size:16px;
      font-weight:800;
      outline:none;
      transition:.2s;
    }
    .input:focus, .select:focus{border-color: rgba(95,115,255,.75); box-shadow:0 0 0 5px rgba(95,115,255,.10);}

    /* ========== BUTTONS ========== */
    .btn{
      height:var(--tap);
      border-radius:18px;
      border:none;
      cursor:pointer;
      font-weight:900;
      font-size:16px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:0 18px;
      transition:.18s cubic-bezier(.2,1,.3,1);
      user-select:none;
    }
    .btnPrimary{background:var(--brand); color:#fff; box-shadow:0 12px 24px rgba(95,115,255,.25);}
    .btnPrimary:hover{transform:translateY(-1px); filter:brightness(1.04);}
    .btnPrimary:active{transform:translateY(0) scale(.98);}
    .btnSoft{background:var(--brand2); color:var(--brand);}
    .btnSoft:hover{transform:translateY(-1px);}
    .btnOutline{background:transparent; border:2px solid var(--line); color:var(--muted);}
    .btnOutline:hover{border-color: rgba(95,115,255,.45); color:var(--brand);}
    .btnDanger{background:rgba(244,63,94,.10); color:var(--red); border:2px solid rgba(244,63,94,.18);}

    .hintBox{
      background:linear-gradient(135deg, rgba(95,115,255,.12), rgba(251,113,133,.10));
      border:1px solid rgba(95,115,255,.18);
      border-radius:20px;
      padding:16px;
    }
    .hintBox h3{margin:0 0 10px; font-size:16px;}
    .hintBox ul{margin:0; padding-left:18px; display:grid; gap:8px; font-weight:700;}
    .miniTag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(245,158,11,.16);
      color:#92400e;
      font-size:12px;
      font-weight:900;
    }

    /* ========== MENU ========== */
    .hudGrid{display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:12px; margin-bottom:14px;}
    @media (max-width: 900px){ .hudGrid{grid-template-columns:1fr; } }
    .hud{
      background:#fff;
      border:1px solid var(--line);
      border-radius:20px;
      padding:14px 16px;
      box-shadow:var(--shadow-sm);
      display:flex; flex-direction:column; gap:6px;
    }
    .hud .k{font-size:12px; color:var(--muted); font-weight:900; letter-spacing:.5px;}
    .hud .v{font-family:"Fredoka","Noto Sans TC",sans-serif; font-weight:900; font-size:20px;}
    .hud .v.small{font-size:16px; font-family:"Noto Sans TC",sans-serif;}
    .hud .v.brand{color:var(--brand);}

    .levelGrid{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px;}
    @media (max-width: 900px){ .levelGrid{grid-template-columns:1fr 1fr;} }
    @media (max-width: 420px){ .levelGrid{grid-template-columns:1fr;} }
    .levelBtn{
      height:110px;
      border-radius:22px;
      border:2px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow-sm);
      cursor:pointer;
      display:flex; flex-direction:column; align-items:flex-start; justify-content:center;
      padding:14px;
      gap:8px;
      font-weight:900;
      transition:.18s;
      text-align:left;
    }
    .levelBtn:hover{border-color: rgba(95,115,255,.55); background:var(--brand2); transform:translateY(-1px);}
    .levelBtn:active{transform:translateY(0) scale(.99);}
    .levelBtn .em{font-size:26px;}
    .levelBtn .sub{font-size:12px; color:var(--muted); font-weight:800; line-height:1.3;}

    /* ========== GAME ========== */
    .gameLayout{display:grid; grid-template-columns: 1fr 320px; gap:18px;}
    @media (max-width: 900px){ .gameLayout{grid-template-columns:1fr;} }

    .qCard{
      position:relative;
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow-lg);
      padding:18px;
      min-height:420px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .topRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:var(--brand2);
      color:var(--brand);
      font-weight:900;
      font-size:12px;
    }

    /* å–‡å­æŒ‰éˆ•ï¼šåªæœ‰æŒ‰äº†æ‰å”¸ */
    .speakBtn{
      width:44px; height:44px;
      border-radius:14px;
      border:2px solid var(--line);
      background:#fff;
      cursor:pointer;
      box-shadow:var(--shadow-sm);
      transition:.18s;
      display:grid; place-items:center;
    }
    .speakBtn:hover{border-color: rgba(95,115,255,.55); background:var(--brand2); color:var(--brand);}
    .speakBtn:active{transform:scale(.98);}

    .qText{
      margin-top:6px;
      font-size:28px;
      font-weight:1000;
      line-height:1.25;
      letter-spacing:-.3px;
    }
    @media (max-width: 420px){ .qText{font-size:24px;} }
    .mono{
      font-family:"Fredoka","Noto Sans TC",sans-serif;
      background:var(--brand2);
      color:var(--brand);
      padding:2px 10px;
      border-radius:12px;
      display:inline-block;
      transform: translateY(-1px);
    }
    .ansGrid{
      margin-top:auto;
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){ .ansGrid{grid-template-columns:1fr;} }

    .choice{
      height:72px;
      border-radius:18px;
      border:2px solid var(--line);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      font-size:20px;
      font-weight:900;
      transition:.18s;
      user-select:none;
    }
    .choice:hover{border-color: rgba(95,115,255,.55); background:var(--brand2); color:var(--brand);}
    .choice:active{transform:scale(.99);}
    .badge{
      width:34px; height:34px;
      border-radius:12px;
      background:rgba(15,23,42,.06);
      display:grid; place-items:center;
      font-size:14px;
      font-weight:1000;
      color:var(--muted);
    }

    .sideCard{
      background:linear-gradient(135deg, #fff, rgba(95,115,255,.08));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow-sm);
      display:flex;
      flex-direction:column;
      align-items:center;
      text-align:center;
      gap:8px;
    }
    .sceneEmoji{font-size:76px; filter: drop-shadow(0 14px 14px rgba(15,23,42,.12));}
    .sceneLine{font-weight:900; color:var(--ink); font-size:16px;}
    .sceneSub{color:var(--muted); font-weight:800; font-size:13px;}
    .tagGold{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(245,158,11,.16);
      color:#92400e;
      font-weight:1000;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
    }

    .sideBtns{margin-top:10px; display:grid; gap:10px; width:100%;}
    .btnSmall{height:48px; border-radius:16px; font-size:14px;}

    /* ========== TIMER BAR ========== */
    .barWrap{width:100%; height:10px; border-radius:999px; background:rgba(15,23,42,.08); overflow:hidden;}
    .bar{height:100%; width:100%; background:var(--brand); transition: width .22s linear;}

    /* ========== FEEDBACK OVERLAY ========== */
    .fb{
      position:absolute; inset:0;
      background:rgba(255,255,255,.96);
      border-radius:var(--radius);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      z-index:10;
      padding:18px;
      animation: fade .18s ease-out;
    }
    .fb.show{display:flex;}
    @keyframes fade{from{opacity:0} to{opacity:1}}
    .fbIcon{font-size:64px; margin-bottom:10px;}
    .fbMsg{font-weight:1000; font-size:26px;}
    .fbAns{margin-top:10px; color:var(--muted); font-weight:900; text-align:center; line-height:1.5;}

    /* ========== MODAL ========== */
    .modal{
      position:fixed; inset:0;
      background:rgba(15,23,42,.62);
      backdrop-filter: blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:220;
      padding:18px;
    }
    .modal.show{display:flex;}
    .modalBox{
      width:100%; max-width:520px;
      background:#fff;
      border-radius:28px;
      box-shadow:var(--shadow-lg);
      padding:22px;
      animation: pop .22s cubic-bezier(.2,1.4,.3,1);
    }
    @keyframes pop{from{opacity:0; transform:scale(.94)} to{opacity:1; transform:scale(1)}}

    /* ========== TABLE ========== */
    .tableWrap{overflow:auto; border:1px solid var(--line); border-radius:18px;}
    table{width:100%; border-collapse:collapse; min-width:520px; background:#fff;}
    th,td{padding:12px 12px; border-bottom:1px solid var(--line); text-align:left; font-weight:900;}
    th{color:var(--muted); font-size:12px; letter-spacing:.4px;}
    td{font-size:14px;}
    .rank{
      width:38px; height:38px; border-radius:14px;
      background:var(--brand2);
      color:var(--brand);
      display:grid; place-items:center;
      font-weight:1000;
    }

    /* ========== TOAST ========== */
    .toast{
      position:fixed;
      bottom:18px; left:50%;
      transform:translateX(-50%);
      background:rgba(15,23,42,.86);
      color:#fff;
      padding:12px 18px;
      border-radius:999px;
      font-weight:900;
      display:none;
      z-index:999;
      box-shadow:0 14px 34px rgba(15,23,42,.24);
      max-width:92vw;
      text-align:center;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      padding:1px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.22);
      margin:0 4px;
      display:inline-block;
    }
  </style>
</head>

<body>
  <!-- HERO / NAV -->
  <nav class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logoWrap" title="Jessie Math">
          <img src="JESSIEMATH-Q.png" alt="Jessie Math Logo">
        </div>
        <div class="brandInfo">
          <h1>Jessie Math</h1>
          <p>äºŒå¹´ç´šï½œä¸»é¡Œä¸€ï½œ200 ä»¥å…§çš„æ•¸</p>
        </div>
      </div>

      <div class="navLinks">
        <a class="pill" href="https://jessiemath0703-chu.github.io/website2/" target="_blank" rel="noopener">
          <i class="fa-solid fa-house"></i><span>é¦–é </span>
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/" target="_blank" rel="noopener">
          <i class="fa-solid fa-gamepad"></i><span>éŠæˆ²å¤§å»³</span>
        </a>
        <a class="pill" href="https://jessiemath0703-chu.github.io/Game-Lobby/#g2-u1" target="_blank" rel="noopener">
          <i class="fa-solid fa-arrow-left"></i><span>äºŒå¹´ç´š 200 ä»¥å…§çš„æ•¸</span>
        </a>
      </div>
    </div>
  </nav>

  <div class="wrap">

    <!-- PAGE 1: NAME -->
    <section id="pageName" class="page active">
      <div class="card">
        <div class="cardHead">
          <h2>é–‹å±€å…ˆå–åï¼šæŠŠåå­—å¯«é€²å‹åˆ©è£¡ âœï¸âœ¨</h2>
          <p>60 ç§’ä¸€å±€ï½œç­”å° +5 ç§’ï½œç­”éŒ¯ -5 ç§’ï½œé€£æ“Šè¶Šé«˜åˆ†è¶Šé¦™</p>
        </div>
        <div class="cardBody">
          <div class="grid2">
            <div>
              <label class="label">ä½ çš„å†’éšªå®¶åå­—ï¼ˆå¿…å¡«ï¼‰</label>
              <input id="nameInput" class="input" maxlength="10" placeholder="ä¾‹å¦‚ï¼šç«ç®­å°ç†Š" />

              <div style="height:14px"></div>

              <label class="label">èªéŸ³è¼”åŠ©ï¼ˆå·²æ”¹æˆï¼šåªæŒ‰å–‡å­æ‰å”¸ï¼‰</label>
              <select id="voicePreset" class="select">
                <option value="tap" selected>åªæŒ‰å–‡å­æ‰å”¸ï¼ˆå›ºå®šï¼‰</option>
                <option value="off">é—œé–‰èªéŸ³</option>
              </select>

              <div style="height:18px"></div>

              <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <button id="btnEnter" class="btn btnPrimary" style="flex:1">
                  <i class="fa-solid fa-rocket"></i> é€²å…¥æŒ‘æˆ°
                </button>
                <button id="btnHow" class="btn btnOutline">
                  <i class="fa-solid fa-circle-question"></i> ç©æ³•èªªæ˜
                </button>
              </div>

              <div style="margin-top:14px; color:var(--muted); font-weight:800; font-size:13px;">
                å°æç¤ºï¼šç­”é¡Œä¹Ÿèƒ½ç”¨éµç›¤ <span class="kbd">1</span><span class="kbd">2</span><span class="kbd">3</span><span class="kbd">4</span>ã€‚
              </div>
            </div>

            <div class="hintBox">
              <div class="miniTag"><i class="fa-solid fa-wand-magic-sparkles"></i> ä»Šæ—¥é­”æ³•è¦å‰‡</div>
              <h3 style="margin:10px 0 8px;">ä½ æœƒç·´åˆ°ä»€éº¼ï¼Ÿ</h3>
              <ul>
                <li>æ•¸åˆ° 200ï¼ˆå¿…è¦æ™‚å»¶ä¼¸åˆ° 300ï¼‰</li>
                <li>ä½å€¼ï¼šç™¾ã€åã€å€‹</li>
                <li>ä»˜éŒ¢èˆ‡æ‰¾é›¶ï¼ˆ200 ä»¥å…§ï¼‰</li>
                <li>å¤§å°æ¯”è¼ƒèˆ‡æ’åº</li>
              </ul>
              <div style="margin-top:12px; color:var(--muted); font-weight:900; font-size:13px;">
                é€™ä¸æ˜¯è€ƒè©¦ï¼Œæ˜¯ä¸€å ´ã€Œæ•¸å­—è¡æµªã€ï¼šè¶Šç©è¶Šæº–ï¼Œè¶Šæº–è¶Šå¸¥ ğŸ˜ğŸŒŠ
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE 2: MENU -->
    <section id="pageMenu" class="page">
      <div class="hudGrid">
        <div class="hud">
          <div class="k">ç©å®¶</div>
          <div class="v small" id="playerNameTag">---</div>
        </div>
        <div class="hud">
          <div class="k">æ¨¡å¼</div>
          <div class="v brand" id="modeTag">æ™®é€šï½œä¸€èˆ¬é€Ÿ</div>
        </div>
        <div class="hud">
          <div class="k">æç¤º</div>
          <div class="v small">ä¸€é—œ 60 ç§’ï½œç­”å° +5ï½œç­”éŒ¯ -5</div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>é¸é—œå¡ï¼šä»Šå¤©ä½ æƒ³ç•¶å“ªä¸€ç¨®æ•¸å­—è‹±é›„ï¼Ÿ ğŸ§ âš¡</h2>
          <p>å…ˆé¸é›£åº¦/é€Ÿåº¦ï¼Œå†é»é—œå¡é–‹å§‹ã€‚æ’è¡Œæ¦œæœƒä¾ã€Œé—œå¡ï¼‹é›£åº¦ã€åˆ†é–‹è¨˜éŒ„ã€‚</p>
        </div>
        <div class="cardBody">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <div style="min-width:200px; flex:1;">
              <label class="label">é›£åº¦</label>
              <select id="difficultySel" class="select">
                <option value="easy">ç°¡å–®ï¼ˆå¾ˆå‹å–„ï¼‰</option>
                <option value="normal" selected>æ™®é€šï¼ˆå‰›å‰›å¥½ï¼‰</option>
                <option value="hard">æŒ‘æˆ°ï¼ˆæ‰‹é€Ÿï¼‹è…¦é€Ÿï¼‰</option>
              </select>
            </div>
            <div style="min-width:200px; flex:1;">
              <label class="label">é€Ÿåº¦</label>
              <select id="speedSel" class="select">
                <option value="slow">æ…¢æ…¢ä¾†ï¼ˆæ›´å¥½æƒ³ï¼‰</option>
                <option value="normal" selected>ä¸€èˆ¬é€Ÿï¼ˆé †é †ç©ï¼‰</option>
                <option value="fast">ç–¾é¢¨é€Ÿï¼ˆåˆºæ¿€ï¼‰</option>
              </select>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="levelGrid">
            <button class="levelBtn" data-level="1">
              <div class="em">ğŸ”¢</div>
              <div>ç¬¬ä¸€é—œï½œæ•¸åˆ° 200</div>
              <div class="sub">å‰å¾Œæ•¸ã€ç¼ºä¸€æ•¸ã€è·³è‘—æ•¸ã€å€’è‘—æ•¸</div>
            </button>
            <button class="levelBtn" data-level="2">
              <div class="em">ğŸ§±</div>
              <div>ç¬¬äºŒé—œï½œç™¾åå€‹ä½å€¼</div>
              <div class="sub">æ‹†æ•¸/çµ„æ•¸ã€å¹¾å€‹åå¹¾å€‹ä¸€ã€ä½æ•¸åˆ¤æ–·</div>
            </button>
            <button class="levelBtn" data-level="3">
              <div class="em">ğŸ’°</div>
              <div>ç¬¬ä¸‰é—œï½œä»˜éŒ¢æ‰¾é›¶</div>
              <div class="sub">ç®—ç¸½åƒ¹ã€æ‰¾é›¶ã€å‰›å¥½ä»˜ï¼ˆ100/50/10/5/1ï¼‰</div>
            </button>
            <button class="levelBtn" data-level="4">
              <div class="em">âš–ï¸</div>
              <div>ç¬¬å››é—œï½œå¤§å°æ¯”è¼ƒ</div>
              <div class="sub">æ¯”å¤§å°ã€æœ€å¤§æœ€å°ã€æ’åºã€ç¬¦è™Ÿ > < =</div>
            </button>
          </div>

          <div style="height:24px"></div>

          <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
              <div style="min-width:180px;">
                <label class="label">æ’è¡Œæ¦œï¼šé—œå¡</label>
                <select id="boardLevelSel" class="select">
                  <option value="1">ç¬¬ä¸€é—œ</option>
                  <option value="2">ç¬¬äºŒé—œ</option>
                  <option value="3">ç¬¬ä¸‰é—œ</option>
                  <option value="4">ç¬¬å››é—œ</option>
                </select>
              </div>
              <div style="min-width:180px;">
                <label class="label">æ’è¡Œæ¦œï¼šé›£åº¦</label>
                <select id="boardDiffSel" class="select">
                  <option value="easy">ç°¡å–®</option>
                  <option value="normal" selected>æ™®é€š</option>
                  <option value="hard">æŒ‘æˆ°</option>
                </select>
              </div>
            </div>

            <button id="btnClearBoard" class="btn btnDanger" style="height:48px;">
              <i class="fa-solid fa-trash"></i> æ¸…ç©ºæœ¬æ©Ÿç´€éŒ„
            </button>
          </div>

          <div style="height:12px"></div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>æ’å</th>
                  <th>ç©å®¶</th>
                  <th>åˆ†æ•¸</th>
                  <th>è©•åˆ†</th>
                  <th>æ—¥æœŸ</th>
                </tr>
              </thead>
              <tbody id="boardBody"></tbody>
            </table>
          </div>

          <div style="margin-top:10px; color:var(--muted); font-weight:900; font-size:12px;">
            å°è¦å‰‡ï¼šæŒ‰ã€Œå›é—œå¡ä¸»é¸å–®ã€æœƒç›´æ¥çµæŸæœ¬å±€ï¼Œ<b>ä¸å¯«å…¥æ’è¡Œæ¦œ</b>ï¼ˆé˜²æ­¢äº‚æŒ‰æ´—æ¦œï¼‰ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- PAGE 3: GAME -->
    <section id="pageGame" class="page">
      <div class="hudGrid">
        <div class="hud" style="border-bottom:4px solid rgba(95,115,255,.65);">
          <div class="k">å‰©é¤˜æ™‚é–“</div>
          <div class="v brand"><span id="timeLeft">60</span>s</div>
          <div class="barWrap"><div id="timeBar" class="bar"></div></div>
        </div>
        <div class="hud">
          <div class="k">åˆ†æ•¸</div>
          <div class="v" id="score">0</div>
        </div>
        <div class="hud">
          <div class="k">Combo é€£æ“Š</div>
          <div class="v" style="color:var(--pink)">
            <span id="combo">0</span>
            <span style="font-size:14px; font-weight:1000;">ï¼ˆx<span id="mult">1.0</span>ï¼‰</span>
          </div>
        </div>
      </div>

      <div class="gameLayout">
        <div class="qCard">
          <div id="feedback" class="fb" aria-live="polite">
            <div id="fbIcon" class="fbIcon">âœ…</div>
            <div id="fbMsg" class="fbMsg">ç­”å°äº†ï¼</div>
            <div id="fbAns" class="fbAns"></div>
          </div>

          <div class="topRow">
            <div class="chip" id="qHint"><i class="fa-solid fa-lightbulb"></i> è½é¡Œç›®ã€çœ‹é¸é …</div>

            <button class="speakBtn" id="btnSpeak" title="æŒ‰äº†æ‰å”¸é¡Œç›®">
              <i class="fa-solid fa-volume-high"></i>
            </button>
          </div>

          <div class="qText" id="qText">æ­£åœ¨æº–å‚™é¡Œç›®â€¦</div>

          <div class="ansGrid" id="ansArea"></div>
        </div>

        <aside>
          <div class="sideCard">
            <div class="sceneEmoji" id="sceneEmoji">ğŸ’</div>
            <div class="sceneLine" id="sceneLine">æº–å‚™å¥½äº†å°±å‡ºç™¼ï¼</div>
            <div class="sceneSub" id="sceneSub">ç”¨æ•¸å­—æŠŠä¸–ç•Œæ’æ•´é½Š âœ¨</div>
            <div class="tagGold" id="sceneTag"><i class="fa-solid fa-bolt"></i> 60 ç§’è¡åˆºä¸­</div>
          </div>

          <div class="sideBtns">
            <button id="btnPause" class="btn btnOutline btnSmall"><i class="fa-solid fa-pause"></i> æš«åœ</button>
            <button id="btnRestart" class="btn btnOutline btnSmall"><i class="fa-solid fa-rotate-right"></i> é‡æ–°</button>
            <button id="btnBackMenu" class="btn btnOutline btnSmall" style="border:none; color:var(--muted);"><i class="fa-solid fa-arrow-left"></i> å›é—œå¡ä¸»é¸å–®</button>
          </div>
        </aside>
      </div>
    </section>
  </div>

  <!-- MODALS -->
  <div id="howOverlay" class="modal" role="dialog" aria-modal="true">
    <div class="modalBox">
      <h2 style="margin:0 0 10px; font-weight:1000;">ç©æ³•èªªæ˜ï¼šæ•¸å­—æµªèŠ±æ‹ä¸Šä¾† ğŸŒŠ</h2>
      <div style="color:var(--ink); font-weight:800; line-height:1.9;">
        â€¢ æ¯å±€ <b>60 ç§’</b>ï¼Œé¡Œç›®æœƒä¸€ç›´éš¨æ©Ÿå‡ºé¡Œã€‚<br>
        â€¢ ç­”å°ï¼š<b>+5 ç§’</b>ï¼Œåˆ†æ•¸å¢åŠ ã€Combo é€£æ“ŠåŠ ä¸€ã€‚<br>
        â€¢ ç­”éŒ¯ï¼š<b>-5 ç§’</b>ï¼ŒCombo æ–·æ‰ï¼Œä½†æœƒå‘Šè¨´ä½ æ­£ç¢ºç­”æ¡ˆã€‚<br>
        â€¢ <b>é‡æ–°</b>ï¼šç«‹åˆ»é‡é–‹åŒé—œåŒé›£åº¦ï¼ˆå›åˆ° 60 ç§’ã€åˆ†æ•¸æ­¸é›¶ï¼‰ã€‚<br>
        â€¢ <b>æš«åœ</b>ï¼šæ™‚é–“åœæ­¢ã€é¡Œç›®é–ä½ã€ç•«é¢æœƒæœ‰æš«åœé®ç½©ã€‚<br>
        â€¢ <b>å›é—œå¡ä¸»é¸å–®</b>ï¼šç›´æ¥çµæŸæœ¬å±€ï¼Œ<b>ä¸å¯«å…¥æ’è¡Œæ¦œ</b>ã€‚<br>
        â€¢ èªéŸ³ï¼š<b>åªæœ‰æŒ‰å³ä¸Šè§’å–‡å­æŒ‰éˆ•</b>æ‰æœƒå”¸é¡Œç›®ã€‚<br>
      </div>
      <div style="margin-top:12px; color:var(--muted); font-weight:900; font-size:13px;">
        å°å½©è›‹ï¼šé€£æ“Šè¶Šé«˜ï¼Œå€ç‡è¶Šç”œï¼›æ˜Ÿæ˜Ÿæœƒåœ¨çµæŸæ™‚çµ¦ä½ ä¸€å€‹æ¼‚äº®çš„å¥é» â˜…
      </div>
      <button id="btnHowClose" class="btn btnPrimary" style="width:100%; margin-top:16px;">
        <i class="fa-solid fa-check"></i> æˆ‘æ‡‚äº†ï¼Œé–‹ç©
      </button>
    </div>
  </div>

  <div id="pauseOverlay" class="modal" role="dialog" aria-modal="true">
    <div class="modalBox" style="text-align:center;">
      <div style="font-size:56px; margin:4px 0 8px;">â˜•</div>
      <h2 style="margin:0; font-weight:1000;">æš«åœä¸­</h2>
      <p style="margin:8px 0 0; color:var(--muted); font-weight:900;">å…ˆæŠŠå‘¼å¸æ”¶å›ä¾†ï¼Œç­‰ä¸€ä¸‹å†æŠŠåˆ†æ•¸å¸¶èµ°ã€‚</p>
      <div style="display:grid; gap:10px; margin-top:16px;">
        <button id="btnResume" class="btn btnPrimary"><i class="fa-solid fa-play"></i> ç¹¼çºŒ</button>
        <button id="btnPauseBack" class="btn btnOutline"><i class="fa-solid fa-flag-checkered"></i> çµæŸé€™å±€ï¼ˆä¸è¨˜éŒ„ï¼‰</button>
      </div>
    </div>
  </div>

  <div id="endOverlay" class="modal" role="dialog" aria-modal="true">
    <div class="modalBox" style="text-align:center;">
      <div style="font-size:64px; margin:6px 0 8px;">ğŸ</div>
      <h2 style="margin:0; font-weight:1000;">æœ¬å±€çµæŸï¼</h2>
      <p id="endText" style="margin:10px 0 0; color:var(--muted); font-weight:900;"></p>

      <div style="display:flex; justify-content:center; gap:14px; flex-wrap:wrap; margin:16px 0;">
        <div class="hud" style="min-width:140px;">
          <div class="k">å¾—åˆ†</div>
          <div class="v" id="endScore">0</div>
        </div>
        <div class="hud" style="min-width:140px;">
          <div class="k">æ˜Ÿç­‰</div>
          <div class="v" id="endStars" style="color:var(--yellow);">â˜…â˜…â˜…</div>
        </div>
      </div>

      <div style="display:grid; gap:10px;">
        <button id="btnEndAgain" class="btn btnPrimary"><i class="fa-solid fa-rotate-right"></i> å†ä¾†ä¸€å±€</button>
        <button id="btnEndMenu" class="btn btnOutline"><i class="fa-solid fa-list"></i> å›ä¸»é¸å–®</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ---------- DOM ----------
    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));
    const pages = { name: $("#pageName"), menu: $("#pageMenu"), game: $("#pageGame") };

    const nameInput = $("#nameInput");
    const voicePresetSel = $("#voicePreset");

    const btnEnter = $("#btnEnter");
    const btnHow = $("#btnHow");
    const howOverlay = $("#howOverlay");
    const btnHowClose = $("#btnHowClose");

    const playerNameTag = $("#playerNameTag");
    const modeTag = $("#modeTag");
    const difficultySel = $("#difficultySel");
    const speedSel = $("#speedSel");

    const boardLevelSel = $("#boardLevelSel");
    const boardDiffSel = $("#boardDiffSel");
    const boardBody = $("#boardBody");
    const btnClearBoard = $("#btnClearBoard");

    const timeLeftEl = $("#timeLeft");
    const timeBarEl = $("#timeBar");
    const scoreEl = $("#score");
    const comboEl = $("#combo");
    const multEl = $("#mult");

    const qHintEl = $("#qHint");
    const qTextEl = $("#qText");
    const ansArea = $("#ansArea");
    const btnSpeak = $("#btnSpeak");

    const sceneEmoji = $("#sceneEmoji");
    const sceneLine = $("#sceneLine");
    const sceneSub = $("#sceneSub");
    const sceneTag = $("#sceneTag");

    const btnPause = $("#btnPause");
    const btnRestart = $("#btnRestart");
    const btnBackMenu = $("#btnBackMenu");

    const pauseOverlay = $("#pauseOverlay");
    const btnResume = $("#btnResume");
    const btnPauseBack = $("#btnPauseBack");

    const feedback = $("#feedback");
    const fbIcon = $("#fbIcon");
    const fbMsg = $("#fbMsg");
    const fbAns = $("#fbAns");

    const endOverlay = $("#endOverlay");
    const endText = $("#endText");
    const endScore = $("#endScore");
    const endStars = $("#endStars");
    const btnEndAgain = $("#btnEndAgain");
    const btnEndMenu = $("#btnEndMenu");

    const toast = $("#toast");

    // ---------- STATE ----------
    const STATE = {
      playerName: "",
      voicePreset: "tap",
      level: 1,
      diff: "normal",
      speed: "normal",

      running: false,
      paused: false,
      lock: false,

      timeLeft: 60,
      score: 0,
      combo: 0,

      currentQ: null,
      lastLevel: null,
      lastDiff: null,
      lastSpeed: null,
    };

    const SPEED = { slow:{tickMs:1000}, normal:{tickMs:1000}, fast:{tickMs:1000} };

    const DIFF = {
      easy:   { maxN: 120, base: 8,  moneyMax: 120 },
      normal: { maxN: 200, base: 10, moneyMax: 200 },
      hard:   { maxN: 300, base: 12, moneyMax: 200 }
    };

    let timerId = null;

    // ---------- UTIL ----------
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function rint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
    function fmtDate(ts){
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da= String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function showToast(msg, ms=1400){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.style.display="none", ms);
    }
    function gotoPage(key){
      Object.values(pages).forEach(p=>p.classList.remove("active"));
      pages[key].classList.add("active");
      window.scrollTo({top:0, behavior:"smooth"});
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (m)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    // ---------- æ•¸å­—è½‰åœ‹å­—ï¼ˆèªéŸ³æ›´ç©©ï¼‰ ----------
    const CN = ["é›¶","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"];
    function numberToZh(n){
      n = Number(n);
      if(!Number.isFinite(n)) return String(n);
      n = Math.round(n);
      if(n < 0) return "è² " + numberToZh(-n);
      if(n === 0) return "é›¶";
      if(n < 10) return CN[n];
      if(n < 20) return "å" + (n%10===0 ? "" : CN[n%10]);
      if(n < 100){
        const t = Math.floor(n/10), o = n%10;
        return CN[t] + "å" + (o===0 ? "" : CN[o]);
      }
      if(n < 1000){
        const h = Math.floor(n/100);
        const rest = n % 100;
        if(rest === 0) return CN[h] + "ç™¾";
        if(rest < 10) return CN[h] + "ç™¾é›¶" + CN[rest];
        return CN[h] + "ç™¾" + numberToZh(rest);
      }
      return String(n);
    }
    function cleanSpeak(s){
      return String(s)
        .replace(/<[^>]+>/g,"")
        .replace(/&nbsp;?/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    // ---------- VOICE ----------
    function getZhVoice(){
      const voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
      return voices.find(v => /zh-TW/i.test(v.lang))
          || voices.find(v => /zh-Hant/i.test(v.lang))
          || voices.find(v => /zh/i.test(v.lang))
          || null;
    }
    function speak(text){
      if(STATE.voicePreset === "off") return;
      if(!("speechSynthesis" in window)) {
        showToast("é€™å°è£ç½®ä¸æ”¯æ´èªéŸ³ ğŸ˜¿");
        return;
      }
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      const v = getZhVoice();
      if(v) u.voice = v;
      u.lang = v?.lang || "zh-TW";
      u.rate = 0.95;
      u.pitch = 1.05;
      speechSynthesis.speak(u);
    }

    // ---------- LEADERBOARD ----------
    function boardKey(level, diff){ return `JM_G2_U1_L${level}_${diff}_board_v1`; }
    function readBoard(level, diff){
      try{ const raw = localStorage.getItem(boardKey(level,diff)); return raw ? JSON.parse(raw) : []; }
      catch(e){ return []; }
    }
    function writeBoard(level, diff, list){ localStorage.setItem(boardKey(level,diff), JSON.stringify(list)); }
    function addToBoard(entry){
      const list = readBoard(entry.level, entry.diff);
      list.push(entry);
      list.sort((a,b)=> b.score - a.score);
      writeBoard(entry.level, entry.diff, list.slice(0,10));
    }
    function renderBoard(){
      const level = Number(boardLevelSel.value);
      const diff = boardDiffSel.value;
      const list = readBoard(level, diff);

      boardBody.innerHTML = "";
      if(list.length === 0){
        boardBody.innerHTML = `
          <tr>
            <td colspan="5" style="padding:18px; color:var(--muted); font-weight:900;">
              ç›®å‰é‚„æ²’æœ‰ç´€éŒ„ï½å¿«å»æ‹¿ç¬¬ä¸€å ğŸ‘‘
            </td>
          </tr>`;
        return;
      }
      list.forEach((e, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><div class="rank">${idx+1}</div></td>
          <td>${escapeHtml(e.name)}</td>
          <td>${e.score}</td>
          <td style="color:var(--yellow); font-weight:1000;">${e.stars || "â˜…"}</td>
          <td>${e.date}</td>`;
        boardBody.appendChild(tr);
      });
    }

    // ---------- COMBO / MULT ----------
    function calcMult(combo){
      if(combo>=13) return 2.0;
      if(combo>=9)  return 1.8;
      if(combo>=6)  return 1.5;
      if(combo>=3)  return 1.2;
      return 1.0;
    }

    // ---------- STAR RATING ----------
    function calcStars(score){
      if(score >= 240) return "â˜…â˜…â˜…";
      if(score >= 180) return "â˜…â˜…";
      if(score >= 120) return "â˜…";
      return "â˜†";
    }

    // ---------- SCENES ----------
    const SCENES = [
      {emoji:"ğŸ¦Š", line:"å°ç‹ç‹¸åœ¨æ•¸æ¾æœ", sub:"ä½ ä¾†ç•¶ç‰ çš„æ•¸å­—å°èˆª"},
      {emoji:"ğŸ¡", line:"é»å¿ƒæ”¤è¦æ¹Šå‰›å¥½", sub:"ä»˜éŒ¢åˆ¥æ‰‹æŠ–"},
      {emoji:"ğŸš²", line:"é¨è…³è¸è»Šæ•¸è·¯æ¨™", sub:"å‰å¾Œæ•¸è¶…å¸¸ç”¨"},
      {emoji:"ğŸ«", line:"æ•™å®¤è£¡æ’éšŠæ¯”å¤§å°", sub:"èª°å¤§èª°å°ä¸€çœ¼çœ‹ç©¿"},
      {emoji:"ğŸ§±", line:"ç©æœ¨åŸåœ¨è“‹é«˜æ¨“", sub:"ç™¾åå€‹æ˜¯å»ºç¯‰å¸«çš„èªè¨€"},
      {emoji:"ğŸ§‹", line:"é£²æ–™åº—æ‰¾é›¶æ™‚é–“", sub:"ç®—å¾—å¿«å°±ä¸æœƒæ’éšŠ"},
      {emoji:"ğŸ§¸", line:"ç©å¶è¦æ’å¾å°åˆ°å¤§", sub:"æ’åºå°±æ˜¯é­”æ³•é™£"},
      {emoji:"ğŸŒˆ", line:"å½©è™¹ä»»å‹™ï¼šè·³è‘—æ•¸", sub:"çœ‹å‡ºè¦å¾‹å°±æœƒé£›"}
    ];
    function setScene(){
      const s = pick(SCENES);
      sceneEmoji.textContent = s.emoji;
      sceneLine.textContent = s.line;
      sceneSub.textContent = s.sub;
    }

    // ---------- QUESTIONSï¼ˆä¿æŒèˆ‡ä¸Šä¸€ç‰ˆä¸€è‡´ï¼‰ ----------
    function genQ(level){
      const d = DIFF[STATE.diff];
      const maxN = d.maxN;

      if(level === 1) return genL1(maxN);
      if(level === 2) return genL2(maxN);
      if(level === 3) return genL3(d.moneyMax);
      return genL4(maxN);
    }

    function pack(hint, text, speakText, correct, choices){
      const ch = shuffle(choices.map(x=>Number(x)));
      const idx = ch.indexOf(Number(correct));
      return {
        hint, text,
        speak: speakText,
        correctValue: Number(correct),
        choices: ch.map(String),
        correctIndex: idx,
        correctValueText: `æ­£ç¢ºï¼š${correct}`,
      };
    }
    function uniqueChoices(correct, min, max, n=4, step=1, mustInclude=[]){
      const set = new Set();
      set.add(Number(correct));
      mustInclude.forEach(v=>set.add(Number(v)));
      while(set.size < n){
        let v = Number(correct) + pick([-3,-2,-1,1,2,3,5,10,15,20]) * step;
        if(Math.random()<0.38) v = rint(min, max);
        v = clamp(v, min, max);
        set.add(Number(v));
      }
      return shuffle(Array.from(set)).slice(0,n);
    }
    function uniqueNumbers(count, min, max){
      const set = new Set();
      while(set.size < count) set.add(rint(min,max));
      return Array.from(set);
    }

    function listNumbersToZh(arr){
      return arr.map(x=> (String(x)==="ç©ºæ ¼" ? "ç©ºæ ¼" : numberToZh(x))).join("ã€");
    }

    function genL1(maxN){
      const cap = Math.max(120, Math.min(maxN, 300));
      const type = pick(["nextprev","missing3","backward","skipFill","between","near200"]);

      if(type === "nextprev"){
        const n = rint(0, cap);
        const ask = pick(["ä¸‹ä¸€å€‹æ•¸æ˜¯ï¼Ÿ","ä¸Šä¸€å€‹æ•¸æ˜¯ï¼Ÿ"]);
        let correct = ask.includes("ä¸‹") ? n+1 : n-1;
        correct = clamp(correct, 0, cap);
        const text = `æ•¸å­— <span class="mono">${n}</span> çš„ã€Œ${ask.replace("æ˜¯ï¼Ÿ","")}ã€`;
        const speakText = `æ•¸å­—${numberToZh(n)}çš„${ask.replace("æ˜¯ï¼Ÿ","")}æ˜¯ä»€éº¼ï¼Ÿ`;
        const choices = uniqueChoices(correct, 0, cap, 4, 1);
        return pack("å‰å¾Œæ•¸", text, speakText, correct, choices);
      }

      if(type === "missing3"){
        const a = rint(0, cap-2);
        const b = a+1, c=a+2;
        const pattern = pick(["a?c","?bc","ab?"]);
        if(pattern==="a?c"){
          const text = `å¡«ç©ºï¼š<span class="mono">${a}</span> â†’ <span class="mono">ï¼Ÿ</span> â†’ <span class="mono">${c}</span>`;
          const speakText = `å¡«ç©ºï¼š${numberToZh(a)}ï¼Œç©ºæ ¼ï¼Œ${numberToZh(c)}ã€‚ç©ºæ ¼æ˜¯å¹¾ï¼Ÿ`;
          return pack("å¡«ç©º", text, speakText, b, uniqueChoices(b, 0, cap, 4, 1));
        }
        if(pattern==="?bc"){
          const text = `å¡«ç©ºï¼š<span class="mono">ï¼Ÿ</span> â†’ <span class="mono">${b}</span> â†’ <span class="mono">${c}</span>`;
          const speakText = `å¡«ç©ºï¼šç©ºæ ¼ï¼Œ${numberToZh(b)}ï¼Œ${numberToZh(c)}ã€‚ç©ºæ ¼æ˜¯å¹¾ï¼Ÿ`;
          return pack("å¡«ç©º", text, speakText, a, uniqueChoices(a, 0, cap, 4, 1));
        }
        const text = `å¡«ç©ºï¼š<span class="mono">${a}</span> â†’ <span class="mono">${b}</span> â†’ <span class="mono">ï¼Ÿ</span>`;
        const speakText = `å¡«ç©ºï¼š${numberToZh(a)}ï¼Œ${numberToZh(b)}ï¼Œç©ºæ ¼ã€‚ç©ºæ ¼æ˜¯å¹¾ï¼Ÿ`;
        return pack("å¡«ç©º", text, speakText, c, uniqueChoices(c, 0, cap, 4, 1));
      }

      if(type === "backward"){
        const step = pick([1,2]);
        const start = rint(step*3, cap);
        const seq = [start, start-step, start-2*step, start-3*step];
        const blankPos = pick([1,2,3]);
        const correct = seq[blankPos];
        const seqHtml = seq.map((v,i)=> i===blankPos ? `<span class="mono">ï¼Ÿ</span>` : `<span class="mono">${v}</span>`).join("ï¼Œ");
        const text = `å€’è‘—æ•¸ï¼š${seqHtml}`;
        const speakText = `å€’è‘—æ•¸ï¼š${numberToZh(seq[0])}ï¼Œ${blankPos===1?"ç©ºæ ¼":numberToZh(seq[1])}ï¼Œ${blankPos===2?"ç©ºæ ¼":numberToZh(seq[2])}ï¼Œ${blankPos===3?"ç©ºæ ¼":numberToZh(seq[3])}ã€‚ç©ºæ ¼æ˜¯å¹¾ï¼Ÿ`;
        return pack("å€’è‘—æ•¸", text, speakText, correct, uniqueChoices(correct, 0, cap, 4, 1));
      }

      if(type === "skipFill"){
        const step = pick([2,5,10]);
        const start = rint(0, Math.floor((cap-3*step)/step))*step;
        const seq = [start, start+step, start+2*step, start+3*step];
        const blankPos = pick([1,2,3]);
        const correct = seq[blankPos];

        const seqHtml = seq.map((v,i)=> i===blankPos ? `<span class="mono">ï¼Ÿ</span>` : `<span class="mono">${v}</span>`).join("ï¼Œ");
        const text = `æ‰¾è¦å¾‹å¡«ç©ºï¼š${seqHtml}`;
        const speakText = `æ‰¾è¦å¾‹å¡«ç©ºï¼š${numberToZh(seq[0])}ï¼Œ${blankPos===1?"ç©ºæ ¼":numberToZh(seq[1])}ï¼Œ${blankPos===2?"ç©ºæ ¼":numberToZh(seq[2])}ï¼Œ${blankPos===3?"ç©ºæ ¼":numberToZh(seq[3])}ã€‚ç©ºæ ¼æ˜¯å¹¾ï¼Ÿ`;
        return pack("æ‰¾è¦å¾‹", text, speakText, correct, uniqueChoices(correct, 0, cap, 4, 1));
      }

      if(type === "between"){
        const a = rint(0, cap-2);
        const c = a+2;
        const correct = a+1;
        const text = `ä¸­é–“æ˜¯èª°ï¼š<span class="mono">${a}</span> å’Œ <span class="mono">${c}</span> ä¸­é–“çš„æ•¸æ˜¯ï¼Ÿ`;
        const speakText = `æ•¸å­—${numberToZh(a)}å’Œ${numberToZh(c)}ä¸­é–“çš„æ•¸æ˜¯å¹¾ï¼Ÿ`;
        return pack("ä¸­é–“çš„æ•¸", text, speakText, correct, uniqueChoices(correct, 0, cap, 4, 1));
      }

      const anchor = pick([200, 199, 198, 201, 202]);
      const ask = pick(["ä¸‹ä¸€å€‹æ•¸æ˜¯ï¼Ÿ","ä¸Šä¸€å€‹æ•¸æ˜¯ï¼Ÿ","å·® 1 æ˜¯ï¼Ÿ"]);
      let correct;
      if(ask==="ä¸‹ä¸€å€‹æ•¸æ˜¯ï¼Ÿ") correct = anchor+1;
      else if(ask==="ä¸Šä¸€å€‹æ•¸æ˜¯ï¼Ÿ") correct = anchor-1;
      else correct = pick([anchor-1, anchor+1]);
      correct = clamp(correct, 0, cap);

      const text = `çœ‹æ¸…æ¥šï¼š<span class="mono">${anchor}</span> çš„ã€Œ${ask.replace("æ˜¯ï¼Ÿ","")}ã€`;
      const speakText = `çœ‹æ¸…æ¥šï¼š${numberToZh(anchor)}çš„${ask.replace("æ˜¯ï¼Ÿ","")}æ˜¯ä»€éº¼ï¼Ÿ`;
      return pack("é è¿‘ 200", text, speakText, correct, uniqueChoices(correct, 0, cap, 4, 1));
    }

    function genL2(maxN){
      const cap = Math.max(120, Math.min(maxN, 300));
      const type = pick(["digits","compose","blocks","whoHasDigit","tensIs"]);

      if(type === "digits"){
        const n = rint(0, cap);
        const h = Math.floor(n/100);
        const t = Math.floor((n%100)/10);
        const o = n%10;
        const ask = pick(["ç™¾ä½æ˜¯å¹¾ï¼Ÿ","åä½æ˜¯å¹¾ï¼Ÿ","å€‹ä½æ˜¯å¹¾ï¼Ÿ","æœ‰å¹¾å€‹åï¼Ÿ","æœ‰å¹¾å€‹ä¸€ï¼Ÿ"]);
        let correct, text, speakText;

        if(ask==="ç™¾ä½æ˜¯å¹¾ï¼Ÿ"){ correct=h; text=`æ•¸å­— <span class="mono">${n}</span> çš„ç™¾ä½æ˜¯ï¼Ÿ`; speakText=`æ•¸å­—${numberToZh(n)}çš„ç™¾ä½æ˜¯å¹¾ï¼Ÿ`; }
        if(ask==="åä½æ˜¯å¹¾ï¼Ÿ"){ correct=t; text=`æ•¸å­— <span class="mono">${n}</span> çš„åä½æ˜¯ï¼Ÿ`; speakText=`æ•¸å­—${numberToZh(n)}çš„åä½æ˜¯å¹¾ï¼Ÿ`; }
        if(ask==="å€‹ä½æ˜¯å¹¾ï¼Ÿ"){ correct=o; text=`æ•¸å­— <span class="mono">${n}</span> çš„å€‹ä½æ˜¯ï¼Ÿ`; speakText=`æ•¸å­—${numberToZh(n)}çš„å€‹ä½æ˜¯å¹¾ï¼Ÿ`; }
        if(ask==="æœ‰å¹¾å€‹åï¼Ÿ"){ correct=Math.floor(n/10); text=`æ•¸å­— <span class="mono">${n}</span> è£¡é¢æœ‰å¹¾å€‹åï¼Ÿ`; speakText=`æ•¸å­—${numberToZh(n)}è£¡é¢æœ‰å¹¾å€‹åï¼Ÿ`; }
        if(ask==="æœ‰å¹¾å€‹ä¸€ï¼Ÿ"){ correct=n; text=`æ•¸å­— <span class="mono">${n}</span> è£¡é¢æœ‰å¹¾å€‹ä¸€ï¼Ÿ`; speakText=`æ•¸å­—${numberToZh(n)}è£¡é¢æœ‰å¹¾å€‹ä¸€ï¼Ÿ`; }

        return pack("ä½å€¼æ‹†æ•¸", text, speakText, correct, uniqueChoices(correct, 0, Math.max(20, correct+20), 4, 1));
      }

      if(type === "compose"){
        const h = rint(0, cap>=200?2:1);
        const t = rint(0,9);
        const o = rint(0,9);
        const n = h*100 + t*10 + o;
        const text = `çµ„ä¸€å€‹æ•¸ï¼š<span class="mono">${h}</span> å€‹ç™¾ã€<span class="mono">${t}</span> å€‹åã€<span class="mono">${o}</span> å€‹ä¸€ï¼Œç­‰æ–¼å¤šå°‘ï¼Ÿ`;
        const speakText = `${numberToZh(h)}å€‹ç™¾ï¼Œ${numberToZh(t)}å€‹åï¼Œ${numberToZh(o)}å€‹ä¸€ï¼Œç­‰æ–¼å¤šå°‘ï¼Ÿ`;
        return pack("ä½å€¼çµ„æ•¸", text, speakText, n, uniqueChoices(n, 0, Math.max(220, cap), 4, 1));
      }

      if(type === "blocks"){
        const h = rint(0, cap>=200?2:1);
        const t = rint(0,9);
        const o = rint(0,9);
        const n = h*100 + t*10 + o;
        const text = `ç©æœ¨é¡Œï¼šç™¾ç©æœ¨ <span class="mono">${h}</span> å€‹ã€åç©æœ¨ <span class="mono">${t}</span> å€‹ã€å€‹ç©æœ¨ <span class="mono">${o}</span> å€‹ï¼Œæ•¸å­—æ˜¯ï¼Ÿ`;
        const speakText = `ç©æœ¨é¡Œï¼šç™¾ç©æœ¨${numberToZh(h)}å€‹ï¼Œåç©æœ¨${numberToZh(t)}å€‹ï¼Œå€‹ç©æœ¨${numberToZh(o)}å€‹ã€‚æ•¸å­—æ˜¯å¹¾ï¼Ÿ`;
        return pack("ç©æœ¨ä½å€¼", text, speakText, n, uniqueChoices(n, 0, Math.max(220, cap), 4, 1));
      }

      if(type === "tensIs"){
        const tens = rint(0,9);
        const n1 = rint(0, cap);
        const n2 = rint(0, cap);
        const n3 = rint(0, cap);
        const makeGood = ()=>{
          const h = rint(0, cap>=200?2:1);
          const o = rint(0,9);
          return h*100 + tens*10 + o;
        };
        const correct = makeGood();
        const choices = shuffle([correct, n1, n2, n3].map(x=>clamp(x,0,cap)));
        const text = `æ‰¾ä¸€å€‹ï¼šåä½æ˜¯ <span class="mono">${tens}</span> çš„æ•¸å­—æ˜¯ï¼Ÿ`;
        const speakText = `æ‰¾ä¸€å€‹ï¼šåä½æ˜¯${numberToZh(tens)}çš„æ•¸å­—æ˜¯å¹¾ï¼Ÿ`;
        return pack("åä½åˆ¤æ–·", text, speakText, correct, choices);
      }

      const digit = rint(0,9);
      const pos = pick(["å€‹ä½","ç™¾ä½"]);
      const make = ()=>{
        const h = rint(0, cap>=200?2:1);
        const t = rint(0,9);
        const o = rint(0,9);
        let n = h*100+t*10+o;
        if(pos==="å€‹ä½") n = h*100 + t*10 + digit;
        else n = digit*100 + t*10 + o;
        return clamp(n, 0, cap);
      };
      const correct = make();
      const wrong = uniqueNumbers(3, 0, cap);
      const choices = shuffle([correct, ...wrong]);
      const text = `æ‰¾ä¸€å€‹ï¼š${pos}æ˜¯ <span class="mono">${digit}</span> çš„æ•¸å­—æ˜¯ï¼Ÿ`;
      const speakText = `æ‰¾ä¸€å€‹ï¼š${pos}æ˜¯${numberToZh(digit)}çš„æ•¸å­—æ˜¯å¹¾ï¼Ÿ`;
      return pack("ä½æ•¸åµæ¢", text, speakText, correct, choices);
    }

    function makeMoneySet(sum){
      const denoms = [100,50,10,5,1];
      let left = sum;
      const counts = {100:0,50:0,10:0,5:0,1:0};
      for(const d of denoms){
        const maxTake = (d===1)? 9 : (d===5? 5 : (d===10? 9 : 3));
        const take = Math.min(Math.floor(left/d), maxTake);
        counts[d] = take;
        left -= take*d;
      }
      if(left>0) counts[1] = Math.min(99, counts[1]+left);
      return {sum, counts};
    }
    function moneySetText(s){
      const c=s.counts, parts=[];
      if(c[100]) parts.push(`100Ã—${c[100]}`);
      if(c[50])  parts.push(`50Ã—${c[50]}`);
      if(c[10])  parts.push(`10Ã—${c[10]}`);
      if(c[5])   parts.push(`5Ã—${c[5]}`);
      if(c[1])   parts.push(`1Ã—${c[1]}`);
      return parts.join(" + ");
    }
    function dedupeMoneySets(arr){
      const seen = new Set(), out=[];
      for(const s of arr){
        const key = moneySetText(s) + "|" + s.sum;
        if(!seen.has(key)){ seen.add(key); out.push(s); }
      }
      return out;
    }
    function genL3(moneyMax){
      const type = pick(["total","change","payExact"]);
      const items = [
        {name:"ğŸ™é£¯ç³°", min:10, max:45},
        {name:"ğŸ§ƒæœæ±", min:15, max:55},
        {name:"ğŸªé¤…ä¹¾", min:12, max:60},
        {name:"ğŸè˜‹æœ", min:8,  max:35},
        {name:"ğŸ§è›‹ç³•", min:20, max:70},
        {name:"ğŸ§‹çå¥¶", min:25, max:75},
      ];
      const it = pick(items);

      if(type==="total"){
        const a = rint(it.min, it.max);
        const b = rint(it.min, it.max);
        let total = a + b;
        if(total > moneyMax) total = rint(30, moneyMax);
        const x = a;
        const y = clamp(total - a, 1, it.max);
        const text = `è²·æ±è¥¿ï¼š${it.name} <span class="mono">${x}</span> å…ƒï¼ŒåŠ ä¸Š ${it.name} <span class="mono">${y}</span> å…ƒï¼Œä¸€å…±å¤šå°‘å…ƒï¼Ÿ`;
        const speakText = `è²·æ±è¥¿ï¼š${numberToZh(x)}å…ƒåŠ ${numberToZh(y)}å…ƒï¼Œä¸€å…±å¤šå°‘å…ƒï¼Ÿ`;
        const correct = x+y;
        return pack("ç®—ç¸½åƒ¹", text, speakText, correct, uniqueChoices(correct, 0, moneyMax, 4, 1));
      }

      if(type==="change"){
        const price = rint(10, Math.min(180, moneyMax));
        const pay = pick([100, 200]).filter(p=>p>=price)[0] || 200;
        const change = pay - price;
        const text = `æ‰¾é›¶é¡Œï¼šè²·æ±è¥¿ <span class="mono">${price}</span> å…ƒï¼Œç”¨ <span class="mono">${pay}</span> å…ƒä»˜éŒ¢ï¼Œè¦æ‰¾å›å¤šå°‘å…ƒï¼Ÿ`;
        const speakText = `æ‰¾é›¶é¡Œï¼š${numberToZh(price)}å…ƒï¼Œç”¨${numberToZh(pay)}å…ƒä»˜ï¼Œæ‰¾å›å¤šå°‘å…ƒï¼Ÿ`;
        return pack("æ‰¾é›¶", text, speakText, change, uniqueChoices(change, 0, pay, 4, 1));
      }

      const target = rint(20, Math.min(180, moneyMax));
      const correctSet = makeMoneySet(target);
      let wrong1 = makeMoneySet(clamp(target + pick([-10,-5,5,10,15]), 1, moneyMax));
      let wrong2 = makeMoneySet(clamp(target + pick([-20,-10,10,20]), 1, moneyMax));
      let wrong3 = makeMoneySet(clamp(target + pick([-15,-5,5,15]), 1, moneyMax));

      const sets = dedupeMoneySets([correctSet, wrong1, wrong2, wrong3]);
      while(sets.length < 4) sets.push(makeMoneySet(rint(1, moneyMax)));

      const correctIdx = sets.findIndex(s => s.sum === target);
      const choices = shuffle(sets.map((s,i)=>({val:i, label: moneySetText(s)})));

      const text = `ä»˜éŒ¢é¡Œï¼šè¦ä»˜ <span class="mono">${target}</span> å…ƒï¼Œå“ªä¸€çµ„éŒ¢å‰›å‰›å¥½ï¼Ÿ`;
      const speakText = `ä»˜éŒ¢é¡Œï¼šè¦ä»˜${numberToZh(target)}å…ƒï¼Œå“ªä¸€çµ„éŒ¢å‰›å‰›å¥½ï¼Ÿ`;

      return {
        hint:"å‰›å¥½ä»˜",
        text,
        speak:speakText,
        correctIndex: choices.findIndex(c=>c.val===correctIdx),
        choices: choices.map(c=>c.label),
        correctValueText: `æ­£ç¢ºï¼š${target} å…ƒ`,
      };
    }

    function genL4(maxN){
      const cap = Math.max(120, Math.min(maxN, 300));
      const type = pick(["compare2","maxmin","order3","sign"]);

      if(type==="compare2"){
        let a=rint(0,cap), b=rint(0,cap);
        while(a===b) b=rint(0,cap);
        const ask = pick(["å“ªå€‹æ¯”è¼ƒå¤§ï¼Ÿ","å“ªå€‹æ¯”è¼ƒå°ï¼Ÿ"]);
        const correct = ask.includes("å¤§") ? Math.max(a,b) : Math.min(a,b);
        const text = `${ask}ï¼š<span class="mono">${a}</span> å’Œ <span class="mono">${b}</span>`;
        const speakText = `${ask} ${numberToZh(a)}å’Œ${numberToZh(b)}`;
        const choices = shuffle([a,b, clamp(correct+pick([1,2,10]),0,cap), clamp(correct+pick([3,5,9]),0,cap)]);
        return pack("æ¯”å¤§å°", text, speakText, correct, choices);
      }

      if(type==="maxmin"){
        const arr = uniqueNumbers(3, 0, cap);
        const ask = pick(["æœ€å¤§æ˜¯ï¼Ÿ","æœ€å°æ˜¯ï¼Ÿ"]);
        const correct = ask.includes("å¤§") ? Math.max(...arr) : Math.min(...arr);
        const text = `æ‰¾ä¸€æ‰¾ï¼š<span class="mono">${arr[0]}</span>ã€<span class="mono">${arr[1]}</span>ã€<span class="mono">${arr[2]}</span>ï¼Œ${ask}`;
        const speakText = `æ‰¾ä¸€æ‰¾ï¼š${listNumbersToZh(arr)}ã€‚${ask}`;
        return pack("æœ€å¤§æœ€å°", text, speakText, correct, uniqueChoices(correct, 0, cap, 4, 1, arr));
      }

      if(type==="order3"){
        const arr = uniqueNumbers(3, 0, cap);
        const ask = pick(["å¾å°åˆ°å¤§æ’å¥½","å¾å¤§åˆ°å°æ’å¥½"]);
        const sorted = arr.slice().sort((a,b)=>a-b);
        if(ask.includes("å¤§åˆ°å°")) sorted.reverse();
        const correct = sorted.join("ã€");
        const wrong1 = shuffle(arr).join("ã€");
        const wrong2 = sorted.slice().reverse().join("ã€");
        const wrong3 = shuffle(uniqueNumbers(3, 0, cap)).join("ã€");
        const choices = shuffle([correct, wrong1, wrong2, wrong3]);
        return {
          hint:"æ’åº",
          text:`æ’åºé¡Œï¼š<span class="mono">${arr[0]}</span>ã€<span class="mono">${arr[1]}</span>ã€<span class="mono">${arr[2]}</span>ï¼Œ${ask}ï¼Ÿ`,
          speak:`æ’åºé¡Œï¼š${listNumbersToZh(arr)}ï¼Œ${ask}ã€‚`,
          correctValue: correct,
          choices,
          correctIndex: choices.indexOf(correct),
          correctValueText: `æ­£ç¢ºï¼š${correct}`,
        };
      }

      let a=rint(0,cap), b=rint(0,cap);
      const correct = a>b ? ">" : a<b ? "<" : "=";
      const text = `é¸ç¬¦è™Ÿï¼š<span class="mono">${a}</span> â–¡ <span class="mono">${b}</span>ï¼ˆå¡« >ã€<ã€=ï¼‰`;
      const speakText = `é¸ç¬¦è™Ÿï¼š${numberToZh(a)}å’Œ${numberToZh(b)}ï¼Œè¦å¡«å¤§æ–¼ã€å°æ–¼ï¼Œé‚„æ˜¯ç­‰æ–¼ï¼Ÿ`;
      const extra = pick([">","<","="]);
      const choices = shuffle([">","<","=", extra]);
      return {
        hint:"ç¬¦è™Ÿæ¯”è¼ƒ",
        text,
        speak:speakText,
        correctValue: correct,
        choices,
        correctIndex: choices.indexOf(correct),
        correctValueText: `æ­£ç¢ºï¼š${a} ${correct} ${b}`,
      };
    }

    // ---------- RENDER QUESTION ----------
    function renderQuestion(){
      if(!STATE.running || STATE.paused) return;

      setScene();
      const q = genQ(STATE.level);
      STATE.currentQ = q;

      qHintEl.innerHTML = `<i class="fa-solid fa-lightbulb"></i> ${escapeHtml(q.hint || "è«‹è§€å¯Ÿé¡Œç›®")}`;
      qTextEl.innerHTML = q.text;

      ansArea.innerHTML = "";
      q.choices.forEach((label, i)=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.innerHTML = `<span>${label}</span><span class="badge">${i+1}</span>`;
        btn.addEventListener("click", ()=> choose(i));
        ansArea.appendChild(btn);
      });
    }

    // ---------- FEEDBACK ----------
    function showFeedback(ok, extra){
      feedback.classList.add("show");
      fbIcon.textContent = ok ? "âœ…" : "âŒ";
      fbIcon.style.color = ok ? "var(--green)" : "var(--red)";
      fbMsg.textContent = ok ? "ç­”å°äº†ï¼" : "å†è©¦ä¸€æ¬¡ä¹Ÿå¾ˆå¸¥ï½";
      fbAns.innerHTML = extra || "";
      setTimeout(()=> feedback.classList.remove("show"), 520);
    }

    // ---------- GAME LOGIC ----------
    function updateHUD(){
      timeLeftEl.textContent = Math.max(0, Math.ceil(STATE.timeLeft));
      const pct = clamp((STATE.timeLeft/60)*100, 0, 100);
      timeBarEl.style.width = pct + "%";

      scoreEl.textContent = STATE.score;
      comboEl.textContent = STATE.combo;
      multEl.textContent = calcMult(STATE.combo).toFixed(1);
    }

    function resetRun(){
      STATE.timeLeft = 60;
      STATE.score = 0;
      STATE.combo = 0;
      STATE.lock = false;

      updateHUD();
      setScene();
      renderQuestion();
    }

    function tick(){
      if(!STATE.running || STATE.paused) return;
      STATE.timeLeft -= 1;
      if(STATE.timeLeft <= 0){
        STATE.timeLeft = 0;
        updateHUD();
        endGame(true);
        return;
      }
      updateHUD();
    }

    function choose(choiceIndex){
      if(!STATE.running || STATE.paused) return;
      if(STATE.lock) return;
      STATE.lock = true;

      const q = STATE.currentQ;
      const ok = choiceIndex === q.correctIndex;

      const base = DIFF[STATE.diff].base;
      const mult = calcMult(STATE.combo);

      if(ok){
        STATE.combo += 1;
        const gain = Math.round(base * mult);
        STATE.score += gain;
        STATE.timeLeft = clamp(STATE.timeLeft + 5, 0, 75);
        showFeedback(true, `<div style="font-weight:1000;">+${gain} åˆ†ã€€+5 ç§’</div><div style="margin-top:6px;">${escapeHtml(q.correctValueText || "")}</div>`);
      }else{
        STATE.combo = 0;
        STATE.timeLeft = clamp(STATE.timeLeft - 5, 0, 75);
        const correctLabel = q.choices[q.correctIndex];
        showFeedback(false, `<div style="font-weight:1000;">-5 ç§’</div><div style="margin-top:6px;">æ­£ç¢ºç­”æ¡ˆï¼š<span class="mono">${escapeHtml(correctLabel)}</span></div>`);
      }

      updateHUD();

      const delay = (STATE.speed === "fast") ? 320 : (STATE.speed === "slow" ? 520 : 420);
      setTimeout(()=>{
        STATE.lock = false;
        renderQuestion();
      }, delay);
    }

    function endGame(saveToBoard){
      STATE.running = false;
      clearInterval(timerId);
      timerId = null;

      const stars = calcStars(STATE.score);
      endScore.textContent = STATE.score;
      endStars.textContent = stars;

      const levelName = ["","ç¬¬ä¸€é—œï½œæ•¸åˆ° 200","ç¬¬äºŒé—œï½œç™¾åå€‹ä½å€¼","ç¬¬ä¸‰é—œï½œä»˜éŒ¢æ‰¾é›¶","ç¬¬å››é—œï½œå¤§å°æ¯”è¼ƒ"][STATE.level];
      endText.textContent = `${STATE.playerName}ï¼Œä½ å‰›å‰›åœ¨ã€Œ${levelName}ã€è·‘å‡ºä¸€æ®µæ¼‚äº®çš„æ•¸å­—è»Œè·¡ã€‚`;

      if(saveToBoard){
        addToBoard({
          name: STATE.playerName,
          score: STATE.score,
          stars,
          date: fmtDate(Date.now()),
          level: STATE.level,
          diff: STATE.diff,
          speed: STATE.speed
        });
        renderBoard();
      }

      endOverlay.classList.add("show");
    }

    function diffLabel(d){ return d==="easy" ? "ç°¡å–®" : d==="hard" ? "æŒ‘æˆ°" : "æ™®é€š"; }
    function speedLabel(s){ return s==="slow" ? "æ…¢æ…¢ä¾†" : s==="fast" ? "ç–¾é¢¨é€Ÿ" : "ä¸€èˆ¬é€Ÿ"; }

    function startGame(level){
      STATE.level = level;
      STATE.diff = difficultySel.value;
      STATE.speed = speedSel.value;

      STATE.lastLevel = STATE.level;
      STATE.lastDiff = STATE.diff;
      STATE.lastSpeed = STATE.speed;

      modeTag.textContent = `${diffLabel(STATE.diff)}ï½œ${speedLabel(STATE.speed)}`;
      sceneTag.innerHTML = `<i class="fa-solid fa-bolt"></i> 60 ç§’è¡åˆºä¸­`;

      gotoPage("game");

      STATE.running = true;
      STATE.paused = false;
      resetRun();

      clearInterval(timerId);
      timerId = setInterval(tick, SPEED[STATE.speed].tickMs);
    }

    function pauseGame(){
      if(!STATE.running || STATE.paused) return;
      STATE.paused = true;
      pauseOverlay.classList.add("show");
      showToast("æš«åœä¸­ â¸ï¸");
    }
    function resumeGame(){
      if(!STATE.running || !STATE.paused) return;
      STATE.paused = false;
      pauseOverlay.classList.remove("show");
      showToast("ç¹¼çºŒï¼ğŸ”¥");
    }

    function restartGame(){
      if(!STATE.running) return;
      STATE.paused = false;
      pauseOverlay.classList.remove("show");
      endOverlay.classList.remove("show");
      STATE.running = true;

      clearInterval(timerId);
      timerId = setInterval(tick, SPEED[STATE.speed].tickMs);

      resetRun();
      showToast("é‡æ–°é–‹å±€ï¼ğŸš€");
    }

    function backToMenu(){
      STATE.running = false;
      STATE.paused = false;
      clearInterval(timerId);
      timerId = null;

      pauseOverlay.classList.remove("show");
      endOverlay.classList.remove("show");

      gotoPage("menu");
      showToast("å›åˆ°ä¸»é¸å–®ï¼ˆæœ¬å±€ä¸è¨˜éŒ„ï¼‰");
    }

    // ---------- âœ… æ–°å¢ï¼šä¸»é¸å–®ç¢°åˆ°é—œå¡å°±å”¸é—œå¡åç¨±ï¼ˆå…¶ä»–ä¸è®Šï¼‰ ----------
    const LEVEL_SPEAK = {
      1: "ç¬¬ä¸€é—œï¼Œæ•¸åˆ°å…©ç™¾",
      2: "ç¬¬äºŒé—œï¼Œç™¾åå€‹ä½å€¼",
      3: "ç¬¬ä¸‰é—œï¼Œä»˜éŒ¢æ‰¾é›¶",
      4: "ç¬¬å››é—œï¼Œå¤§å°æ¯”è¼ƒ"
    };
    const sayLevelIfMenu = (level)=>{
      // åªåœ¨é¸é—œå¡é‚£é æ‰å”¸
      if(!pages.menu.classList.contains("active")) return;
      if(STATE.voicePreset === "off") return;
      speak(LEVEL_SPEAK[level] || `ç¬¬${numberToZh(level)}é—œ`);
    };

    // ---------- EVENTS ----------
    btnHow.addEventListener("click", ()=> howOverlay.classList.add("show"));
    btnHowClose.addEventListener("click", ()=> howOverlay.classList.remove("show"));
    howOverlay.addEventListener("click", (e)=>{ if(e.target === howOverlay) howOverlay.classList.remove("show"); });

    btnEnter.addEventListener("click", ()=>{
      const name = nameInput.value.trim();
      if(!name){
        showToast("åå­—è¦å…ˆå¯«å–” âœï¸");
        nameInput.focus();
        return;
      }
      STATE.playerName = name;
      STATE.voicePreset = voicePresetSel.value === "off" ? "off" : "tap";

      playerNameTag.textContent = STATE.playerName;
      modeTag.textContent = `${diffLabel(difficultySel.value)}ï½œ${speedLabel(speedSel.value)}`;

      gotoPage("menu");
      renderBoard();
    });
    nameInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") btnEnter.click(); });

    voicePresetSel.addEventListener("change", ()=>{
      STATE.voicePreset = voicePresetSel.value === "off" ? "off" : "tap";
      showToast(STATE.voicePreset === "off" ? "èªéŸ³å·²é—œé–‰" : "èªéŸ³ï¼šæŒ‰å–‡å­æ‰å”¸");
    });

    difficultySel.addEventListener("change", ()=> modeTag.textContent = `${diffLabel(difficultySel.value)}ï½œ${speedLabel(speedSel.value)}`);
    speedSel.addEventListener("change", ()=> modeTag.textContent = `${diffLabel(difficultySel.value)}ï½œ${speedLabel(speedSel.value)}`);

    $$(".levelBtn").forEach(btn=>{
      const lv = Number(btn.dataset.level);

      // âœ… æ–°å¢ï¼šç¢°åˆ°/æ»‘é/èšç„¦å°±å”¸é—œå¡ï¼ˆä¸å½±éŸ¿é»æ“Šé€²é—œï¼‰
      btn.addEventListener("pointerenter", ()=> sayLevelIfMenu(lv));
      btn.addEventListener("focus", ()=> sayLevelIfMenu(lv));
      btn.addEventListener("touchstart", ()=> sayLevelIfMenu(lv), {passive:true});

      // åŸæœ¬é»æ“Šé€²é—œç¶­æŒ
      btn.addEventListener("click", ()=> startGame(lv));
    });

    // å–‡å­ï¼šåªå”¸é¡Œç›®
    btnSpeak.addEventListener("click", ()=>{
      if(!STATE.currentQ) return;
      if(STATE.paused) return;

      let t = cleanSpeak(STATE.currentQ.speak || "");
      if(!t) return;
      t = t.replace(/\d+/g, (m)=> numberToZh(Number(m)));
      speak(t);
      showToast("ğŸ”Š å·²å”¸é¡Œç›®");
    });

    btnPause.addEventListener("click", pauseGame);
    btnResume.addEventListener("click", resumeGame);
    btnPauseBack.addEventListener("click", backToMenu);

    btnRestart.addEventListener("click", restartGame);
    btnBackMenu.addEventListener("click", backToMenu);

    endOverlay.addEventListener("click", (e)=>{ if(e.target === endOverlay) endOverlay.classList.remove("show"); });
    btnEndAgain.addEventListener("click", ()=>{
      endOverlay.classList.remove("show");
      difficultySel.value = STATE.lastDiff || STATE.diff;
      speedSel.value = STATE.lastSpeed || STATE.speed;
      startGame(STATE.lastLevel || STATE.level);
    });
    btnEndMenu.addEventListener("click", ()=>{
      endOverlay.classList.remove("show");
      gotoPage("menu");
      renderBoard();
    });

    pauseOverlay.addEventListener("click", (e)=>{ if(e.target === pauseOverlay) resumeGame(); });

    boardLevelSel.addEventListener("change", renderBoard);
    boardDiffSel.addEventListener("change", renderBoard);

    btnClearBoard.addEventListener("click", ()=>{
      const ok = confirm("ç¢ºå®šè¦æ¸…ç©ºç›®å‰ã€Œé—œå¡ï¼‹é›£åº¦ã€çš„æ’è¡Œæ¦œå—ï¼Ÿ");
      if(!ok) return;
      writeBoard(Number(boardLevelSel.value), boardDiffSel.value, []);
      renderBoard();
      showToast("å·²æ¸…ç©º âœ…");
    });

    window.addEventListener("keydown", (e)=>{
      if(!STATE.running || STATE.paused) return;
      if(STATE.lock) return;

      const k = e.key;
      if(k === "1" || k === "2" || k === "3" || k === "4"){
        const idx = Number(k)-1;
        if(idx >= 0 && idx < 4) choose(idx);
      }
      if(k === " "){
        e.preventDefault();
        STATE.paused ? resumeGame() : pauseGame();
      }
      if(k.toLowerCase() === "r"){
        restartGame();
      }
      if(k.toLowerCase() === "v"){
        btnSpeak.click();
      }
    });

    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        howOverlay.classList.remove("show");
        if(pauseOverlay.classList.contains("show")) resumeGame();
        if(endOverlay.classList.contains("show")) endOverlay.classList.remove("show");
      }
    });

    if("speechSynthesis" in window){
      speechSynthesis.onvoiceschanged = ()=>{};
    }

    renderBoard();
  </script>
</body>
</html>
